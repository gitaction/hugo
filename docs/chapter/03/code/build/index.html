<!doctype html><html lang=zh dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Build源码分析 # 站点已经准备就绪，所有的依赖都已经各就各位。 从的主流程来看，接下来是时候进行最终构建了：
Build时序图 # 接下来，让我们从源码实现的角度来进一步分析:
很清晰的三步：
process：将文件系统的文件，有序地添加到内容图谱中。 assemble：将内容图谱转换成页面图谱，为每一个内容图谱中的结点创建页面，包括首页、章节等结构页面。 render：根据模板以及页面信息，进行最终站点渲染。 Process时序图 # 从中间可以看到，在开始处理之前，Site进行了初始化，以做好处理的准备。 开始处理内容时，先创建了资源规范NewSourceSpec，正是后续组件所要处理的内容。 紧接着创建页面处理器PagesProcessor和PagesCollector。 然后由收集器，从目录开始收集。
通过明确的分工，高效的协作，最终将所有文件分门别类，规整地放在中心货架上。
现在我们来看看具体地实现思路和细节。
先来举个例子：
比如我们有两组数据要进行处理，一组是整型，一组是字符型。 我们需要一个来统筹管理的，分发任务。 还需要具体来处理信息的，一个整型处理器，一个字符型处理器。 为了让处理器之前紧密配合，就需要对处理流程进行统一。 可以看到总共分为三步，分别是开始、处理和等待。 这样在不同的阶段，负责协调的PagesProcessor就可以让其它的处理器各就各位，等待明确的信息就行。 其中在开始阶段，整型处理器和字符型处理器就已经准备好。 等待协调处理器发送具体处理对象了，这里用到了golang的频道作为信息传输通道。
页面是处理完成了，那我们的货架又长什么样，处理好的内容需要如何摆在这些货架上呢？
Hugo给这个货架取的名字是contentMap。 包含了好几颗树：pages tree, sections tree, resources tree。 没错，contentMap就是这些树的集合：
type contentMap struct { // View of regular pages, sections, and taxonomies. pageTrees contentTrees // View of pages, sections, taxonomies, and resources. bundleTrees contentTrees // Stores page bundles keyed by its path's directory or the base filename, // e."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="3.5.4 构建"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://hugo.notes.sunwei.xyz/docs/chapter/03/code/build/"><title>3.5.4 构建 | Deep Dive into Hugo: Becoming an Expert in the Static Site Generator Domain</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css integrity="sha256-xYKS02sYtnVoCrm66iApIEU3uDnqcvJYdG7A8yzo1sg=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/zh.search.min.35de7fc157bc39cdcef2a3b7d8dadeea492103e1ea935a8c216f01e6baf1c4c3.js integrity="sha256-Nd5/wVe8Oc3O8qO32Nre6kkhA+Hqk1qMIW8B5rrxxMM=" crossorigin=anonymous></script>
<script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-STPKPBQR5Y"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-STPKPBQR5Y",{anonymize_ip:!1})}</script><link rel=alternate type=application/rss+xml href=https://hugo.notes.sunwei.xyz/docs/chapter/03/code/build/index.xml title="Deep Dive into Hugo: Becoming an Expert in the Static Site Generator Domain"></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Deep Dive into Hugo: Becoming an Expert in the Static Site Generator Domain</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul class=book-languages><li><input type=checkbox id=languages class=toggle>
<label for=languages class="flex justify-between"><a role=button class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
Chinese</a></label><ul><li><a href=https://hugo.notes.sunwei.xyz/en/>English</a></li></ul></li></ul><ul><li><p><a href=/docs/introduction/><strong>引言</strong></a><br></p></li><li><p><a href=/docs/chapter/01/><strong>第一章 Hugo入门</strong></a></p><ul><li><a href=/docs/chapter/01/ssg/>1.1 静态站点的背景和重要性</a></li><li><a href=/docs/chapter/01/hugo/>1.2 Hugo简介</a></li><li><a href=/docs/chapter/01/install/>1.3 安装Hugo</a></li><li><a href=/docs/chapter/01/site/>1.4 创建第一个站点</a></li><li><a href=/docs/chapter/01/theme/>1.5 自定义主题</a></li><li><a href=/docs/chapter/01/sunweixyz/>1.6 个人站点实例</a><ul><li><a href=/docs/chapter/01/sunweixyz/site/>个人站点</a></li><li><a href=/docs/chapter/01/sunweixyz/theme/>创建新主题</a></li><li><a href=/docs/chapter/01/sunweixyz/deploy/>部署GitHub Pages</a></li></ul></li><li><a href=/docs/chapter/01/qa/>1.7 常见问题和资源</a><br></li></ul></li><li><p><strong>第二章 DDD简介</strong></p><ul><li><a href=/docs/chapter/02/ddd/>2.1 DDD简介</a></li><li><a href=/docs/chapter/02/dddplayer/>2.2 DDD在本书中的应用</a><br></li></ul></li><li><p><a href=/docs/chapter/03/><strong>第三章 Hugo源码精读</strong></a></p><ul><li><a href=/docs/chapter/03/read/>3.1 源码阅读步骤介绍</a></li><li><a href=/docs/chapter/03/prerequisite/>3.2 Hugo本地环境搭建</a></li><li><a href=/docs/chapter/03/dddplayer/>3.3 安装DDDPlayer</a></li><li><a href=/docs/chapter/03/arch/>3.4 Hugo架构设计</a></li><li><a href=/docs/chapter/03/code/>3.5 Hugo源码精读</a><ul><li><a href=/docs/chapter/03/code/config/>3.5.1 配置</a></li><li><a href=/docs/chapter/03/code/deps/>3.5.2 依赖</a><ul><li><a href=/docs/chapter/03/code/deps/pathSpec/>3.5.2.1 PathSpec</a></li><li><a href=/docs/chapter/03/code/deps/contentSpec/>3.5.2.2 ContentSpec</a></li></ul></li><li><a href=/docs/chapter/03/code/site/>3.5.3 站点</a><ul><li><a href=/docs/chapter/03/code/site/create/>3.5.3.1 创建</a></li><li><a href=/docs/chapter/03/code/site/load/>3.5.3.2 加载</a></li><li><a href=/docs/chapter/03/code/site/markdown/>3.5.3.3 Markdown</a></li></ul></li><li><a href=/docs/chapter/03/code/build/ class=active>3.5.4 构建</a><ul><li><a href=/docs/chapter/03/code/build/template/>3.5.4.1 模板</a><br></li></ul></li></ul></li></ul></li><li><p><a href=/docs/chapter/04/><strong>第四章 DDD Hugo</strong></a></p><ul><li><a href=/docs/chapter/04/hugoverse/>4.1 Hugoverse</a></li><li><a href=/docs/chapter/04/demo/>4.2 Hugo 样例工程</a></li><li><a href=/docs/chapter/04/config/>4.3 DDD Hugo 配置信息</a><br></li></ul></li></ul><ul><li><a href=/posts/>Blog</a></li><li><a href=https://github.com/sunwei/hugo-book target=_blank rel=noopener>Github</a></li><li><a href=https://themes.gohugo.io/hugo-book/ target=_blank rel=noopener>Hugo Themes</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>3.5.4 构建</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#build源码分析>Build源码分析</a><ul><li><a href=#build时序图>Build时序图</a><ul><li><a href=#process时序图>Process时序图</a></li><li><a href=#process动手实践>process动手实践</a></li><li><a href=#assemble>Assemble</a></li><li><a href=#pagestate>PageState</a></li><li><a href=#pagestate动手实践>PageState动手实践</a></li><li><a href=#render>Render</a></li><li><a href=#publish动手实践>Publish动手实践</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=build源码分析>Build源码分析
<a class=anchor href=#build%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90>#</a></h1><p>站点已经准备就绪，所有的依赖都已经各就各位。
从的主流程来看，接下来是时候进行最终构建了：</p><p><img src=images/0-main-process.svg alt="Main Process"></p><h2 id=build时序图>Build时序图
<a class=anchor href=#build%e6%97%b6%e5%ba%8f%e5%9b%be>#</a></h2><p>接下来，让我们从源码实现的角度来进一步分析:</p><p><img src=images/13.0-Hugo-Sites-Build.svg alt="Build Sequence Flow"></p><p>很清晰的三步：</p><ul><li>process：将文件系统的文件，有序地添加到内容图谱中。</li><li>assemble：将内容图谱转换成页面图谱，为每一个内容图谱中的结点创建页面，包括首页、章节等结构页面。</li><li>render：根据模板以及页面信息，进行最终站点渲染。</li></ul><h3 id=process时序图>Process时序图
<a class=anchor href=#process%e6%97%b6%e5%ba%8f%e5%9b%be>#</a></h3><p><img src=images/13.1-Hugo-Sites-Build-process.svg alt="Build Process sequence flow"></p><p>从中间可以看到，在开始处理之前，Site进行了初始化，以做好处理的准备。
开始处理内容时，先创建了资源规范NewSourceSpec，正是后续组件所要处理的内容。
紧接着创建页面处理器PagesProcessor和PagesCollector。
然后由收集器，从目录开始收集。</p><p>通过明确的分工，高效的协作，最终将所有文件分门别类，规整地放在中心货架上。</p><p><img src=images/5.0-content-process-flow.svg alt="Content Process Flow"></p><p>现在我们来看看具体地实现思路和细节。</p><p>先来举个例子：</p><p><img src=images/13.2-Hugo-Sites-Build-process-example.svg alt="Process Example"></p><p>比如我们有两组数据要进行处理，一组是整型，一组是字符型。
我们需要一个来统筹管理的，分发任务。
还需要具体来处理信息的，一个整型处理器，一个字符型处理器。
为了让处理器之前紧密配合，就需要对处理流程进行统一。
可以看到总共分为三步，分别是开始、处理和等待。
这样在不同的阶段，负责协调的PagesProcessor就可以让其它的处理器各就各位，等待明确的信息就行。
其中在开始阶段，整型处理器和字符型处理器就已经准备好。
等待协调处理器发送具体处理对象了，这里用到了golang的频道作为信息传输通道。</p><p>页面是处理完成了，那我们的货架又长什么样，处理好的内容需要如何摆在这些货架上呢？</p><p><img src=images/13.3-Hugo-Sites-Build-process-contentMap.svg alt=ContentMap></p><p>Hugo给这个货架取的名字是contentMap。
包含了好几颗树：pages tree, sections tree, resources tree。
没错，contentMap就是这些树的集合：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>contentMap</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// View of regular pages, sections, and taxonomies.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pageTrees</span> <span style=color:#a6e22e>contentTrees</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// View of pages, sections, taxonomies, and resources.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>bundleTrees</span> <span style=color:#a6e22e>contentTrees</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Stores page bundles keyed by its path&#39;s directory or the base filename,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// e.g. &#34;blog/post.md&#34; =&gt; &#34;/blog/post&#34;, &#34;blog/post/index.md&#34; =&gt; &#34;/blog/post&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// These are the &#34;regular pages&#34; and all of them are bundles.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pages</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>contentTree</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Section nodes.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sections</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>contentTree</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Resources stored per bundle below a common prefix, e.g. &#34;/blog/post__hb_&#34;.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>resources</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>contentTree</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>其中pageTrees和bundleTrees又是树的集合：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newContentMap</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>contentMap</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>contentMap</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pages</span>:     <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>contentTree</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#e6db74>&#34;pages&#34;</span>, <span style=color:#a6e22e>Tree</span>: <span style=color:#a6e22e>radix</span>.<span style=color:#a6e22e>New</span>()},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sections</span>:  <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>contentTree</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#e6db74>&#34;sections&#34;</span>, <span style=color:#a6e22e>Tree</span>: <span style=color:#a6e22e>radix</span>.<span style=color:#a6e22e>New</span>()},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resources</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>contentTree</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#e6db74>&#34;resources&#34;</span>, <span style=color:#a6e22e>Tree</span>: <span style=color:#a6e22e>radix</span>.<span style=color:#a6e22e>New</span>()},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>pageTrees</span> = []<span style=color:#f92672>*</span><span style=color:#a6e22e>contentTree</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>pages</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>sections</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>bundleTrees</span> = []<span style=color:#f92672>*</span><span style=color:#a6e22e>contentTree</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>pages</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>sections</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>m</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>是为了方便后续的统一操作。</p><p>结合这些信息，再回过头来看上面的样例。</p><p>我们的目的是用contentMap组织好文件系统里的文件。
在示例中，contentMap可以将页面和资源有效的组织在一起，像header和resources。
其中"blog/a/index.md"是一个页面，&ldquo;blog/a/b/data.json"和"blog/a/logo.png"都是资源文件，一个是数据类型，一个是图片类型。
最终都会以contentNode的形式，添加到对应的树中。
其中section tree也新增了一个结点，虽然没有相应的文件信息(fi: nil)，但path信息是&rdquo;/blog/"。</p><p>树的数据结构是基数树，如何将识别到的信息放入相应的位置，则属于Hugo的领域知识。</p><p>比如Section的定义:
<a href=https://gohugo.io/content-management/sections/>sections</a>。
第一级目录就是section，这是为什么"/blog/&ldquo;会出现在章节树的结点中。
还有一种情况也属于章节，那主是任何包含了&rdquo;_index.后缀"格式文件的目录，也属于章节。
同时Hugo管这种结构叫
<a href=https://gohugo.io/content-management/page-bundles/#branch-bundles>Branch Bundles</a>。
直译就是分支。
那为什么要这样组织？
实际上是由Web
<a href=https://webstyleguide.com/wsg3/3-information-architecture/3-site-structure.html>站点结构</a>定义的。
Web站点的页面结构就是树状的。
有主页，了就是home page，还有不同的章节，如关于页面about page，它们都是从树根主页拓展开来的。</p><p>从站点结构就可以看出，站点页面有像主页，章节这样的索引页面，也有像某一篇博客这样的内容页面。
Hugo管前者叫
<a href=https://gohugo.io/templates/lists/>List Page</a>，后者则是普通页面。
在站点主题的模板中，都有对应的模板，像<code>layouts/_default/list.html</code>，<code>layouts/posts/single.html</code>。</p><p>Hugo正是根据站点的这些规律，按自己的理解，抽象出了List Page, Branch Bundle等等这些概念，将信息组织在了一起，并放入ContentMap中。</p><p>再结合我们一直所使用的实例来检验一下：</p><p><img src=images/13.4-Hugo-Sites-Build-process-contentMap-example.svg alt="ContentMap real case"></p><h3 id=process动手实践>process动手实践
<a class=anchor href=#process%e5%8a%a8%e6%89%8b%e5%ae%9e%e8%b7%b5>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;golang.org/x/sync/errgroup&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strconv&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>set</span>{<span style=color:#a6e22e>elements</span>: []<span style=color:#66d9ef>string</span>{}}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newPagesProcessor</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> []<span style=color:#a6e22e>any</span>{<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#34;hello&#34;</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>, <span style=color:#e6db74>&#34;world&#34;</span>, <span style=color:#e6db74>&#34;happy&#34;</span>}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>data</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Process</span>(<span style=color:#a6e22e>d</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>set</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>elements</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>set</span>) <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>element</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>elements</span> = append(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>elements</span>, <span style=color:#a6e22e>element</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pageProcessor</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Process</span>(<span style=color:#a6e22e>item</span> <span style=color:#a6e22e>any</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Wait</span>() <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newPagesProcessor</span>(<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>set</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>pagesProcessor</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ps</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>pageProcessor</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ps</span>[<span style=color:#e6db74>&#34;i&#34;</span>] = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>intProcessor</span>{<span style=color:#a6e22e>processor</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>:        <span style=color:#a6e22e>s</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>itemChan</span>: make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>interface</span>{}, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span>	}}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ps</span>[<span style=color:#e6db74>&#34;s&#34;</span>] = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stringProcessor</span>{<span style=color:#a6e22e>processor</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>:        <span style=color:#a6e22e>s</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>itemChan</span>: make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>interface</span>{}, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span>	}}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pagesProcessor</span>{<span style=color:#a6e22e>processors</span>: <span style=color:#a6e22e>ps</span>}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pagesProcessor</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>processors</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>pageProcessor</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pagesProcessor</span>) <span style=color:#a6e22e>Process</span>(<span style=color:#a6e22e>item</span> <span style=color:#a6e22e>any</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>item</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Page bundles mapped to their language.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>int</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>processors</span>[<span style=color:#e6db74>&#34;i&#34;</span>].<span style=color:#a6e22e>Process</span>(<span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>string</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>processors</span>[<span style=color:#e6db74>&#34;s&#34;</span>].<span style=color:#a6e22e>Process</span>(<span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;unrecognized item type in Process: %T&#34;</span>, <span style=color:#a6e22e>item</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pagesProcessor</span>) <span style=color:#a6e22e>Start</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>proc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>processors</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span> = <span style=color:#a6e22e>proc</span>.<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctx</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pagesProcessor</span>) <span style=color:#a6e22e>Wait</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>proc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>processors</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>proc</span>.<span style=color:#a6e22e>Wait</span>(); <span style=color:#a6e22e>e</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>e</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>processor</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>         <span style=color:#f92672>*</span><span style=color:#a6e22e>set</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span>       <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>itemChan</span>  <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>any</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>itemGroup</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>errgroup</span>.<span style=color:#a6e22e>Group</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>processor</span>) <span style=color:#a6e22e>Process</span>(<span style=color:#a6e22e>item</span> <span style=color:#a6e22e>any</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>itemChan</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>item</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>processor</span>) <span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>itemGroup</span>, <span style=color:#a6e22e>ctx</span> = <span style=color:#a6e22e>errgroup</span>.<span style=color:#a6e22e>WithContext</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ctx</span> = <span style=color:#a6e22e>ctx</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctx</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>processor</span>) <span style=color:#a6e22e>Wait</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	close(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>itemChan</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>itemGroup</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>intProcessor</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>processor</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>i</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>intProcessor</span>) <span style=color:#a6e22e>Start</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> = <span style=color:#a6e22e>i</span>.<span style=color:#a6e22e>processor</span>.<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>i</span>.<span style=color:#a6e22e>processor</span>.<span style=color:#a6e22e>itemGroup</span>.<span style=color:#a6e22e>Go</span>(<span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>item</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>i</span>.<span style=color:#a6e22e>processor</span>.<span style=color:#a6e22e>itemChan</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>i</span>.<span style=color:#a6e22e>doProcess</span>(<span style=color:#a6e22e>item</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctx</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>i</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>intProcessor</span>) <span style=color:#a6e22e>doProcess</span>(<span style=color:#a6e22e>item</span> <span style=color:#a6e22e>any</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>item</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>int</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>i</span>.<span style=color:#a6e22e>processor</span>.<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>v</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;unrecognized item type in intProcess: %T&#34;</span>, <span style=color:#a6e22e>item</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>stringProcessor</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>processor</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>i</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>stringProcessor</span>) <span style=color:#a6e22e>Start</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> = <span style=color:#a6e22e>i</span>.<span style=color:#a6e22e>processor</span>.<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>i</span>.<span style=color:#a6e22e>processor</span>.<span style=color:#a6e22e>itemGroup</span>.<span style=color:#a6e22e>Go</span>(<span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>item</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>i</span>.<span style=color:#a6e22e>processor</span>.<span style=color:#a6e22e>itemChan</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>i</span>.<span style=color:#a6e22e>doProcess</span>(<span style=color:#a6e22e>item</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctx</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>i</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>stringProcessor</span>) <span style=color:#a6e22e>doProcess</span>(<span style=color:#a6e22e>item</span> <span style=color:#a6e22e>any</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>item</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>string</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>i</span>.<span style=color:#a6e22e>processor</span>.<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;unrecognized item type in stringProcessor: %T&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>item</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>输出样例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&amp;<span style=color:#f92672>{[</span><span style=color:#ae81ff>1</span> hello <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>6</span> world happy<span style=color:#f92672>]}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Program exited.
</span></span></code></pre></div><ul><li><a href=https://c.sunwei.xyz/page-processor.html>Build Processor线上可直接运行版本</a></li></ul><h3 id=assemble>Assemble
<a class=anchor href=#assemble>#</a></h3><p><img src=images/13.5-Hugo-Sites-Build-pageMaps.svg alt=PageMaps></p><p>Assemble所做的事情很纯粹，那就是创建站点页面实例 - pageState。
因为支持多站点，contentMaps有多个。
所以Assemble不仅要创建pageState，还需要管理好所有的pages，这就用到了PageMaps。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pageMap</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Site</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>*</span><span style=color:#a6e22e>contentMap</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pageMaps</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>workers</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>para</span>.<span style=color:#a6e22e>Workers</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pmaps</span>   []<span style=color:#f92672>*</span><span style=color:#a6e22e>pageMap</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>实际上pageMap就是由contentMap组合而来的。
而contentMap中的组成树的结点就是contentNode。</p><p>正好，每个contentNode又对应一个pageState。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>contentNode</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pageState</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Set if source is a file.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// We will soon get other sources.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>fi</span> <span style=color:#a6e22e>hugofs</span>.<span style=color:#a6e22e>FileMetaInfo</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The source path. Unix slashes. No leading slash.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>path</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>所以Assemble不仅要为前面Process处理过生成的contentNode创建pageState，还要补齐一些缺失的contentNode，如Section。</p><h3 id=pagestate>PageState
<a class=anchor href=#pagestate>#</a></h3><p>可以看出，Assemble的重点就是组建PageState，那她到底长啥样：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pageState</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This slice will be of same length as the number of global slice of output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// formats (for all sites).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pageOutputs</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>pageOutput</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This will be shifted out when we start to render a new output format.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#f92672>*</span><span style=color:#a6e22e>pageOutput</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Common for all output formats.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#f92672>*</span><span style=color:#a6e22e>pageCommon</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>从注解中可以看出普通信息将由pageCommon提供，而输出信息则由pageOutput提供。
比较特殊的是pageOutputs，是pageOutput的数组。
在
<a href=../how/%e5%9f%ba%e7%a1%80%e6%9e%b6%e6%9e%84.md>基础架构</a>中，对这一点有作分析。
这要归因于Hugo的多站点渲染策略 - 允许在不同的站点中重用其它站点的页面。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// hugo-playground/hugolib/page__new.go
</span></span></span><span style=display:flex><span><span style=color:#75715e>// line 97
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Prepare output formats for all sites.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// We do this even if this page does not get rendered on
</span></span></span><span style=display:flex><span><span style=color:#75715e>// its own. It may be referenced via .Site.GetPage and
</span></span></span><span style=display:flex><span><span style=color:#75715e>// it will then need an output format.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>pageOutputs</span> = make([]<span style=color:#f92672>*</span><span style=color:#a6e22e>pageOutput</span>, len(<span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>renderFormats</span>))
</span></span></code></pre></div><p>那在Assemble中Hugo是如何组织pageState实例的呢？</p><p><img src=images/13.6.2-Hugo-Sites-Build-pageState-assemble.svg alt="PageState Assemble"></p><p>从上图中，可以看出Assemble阶段主要是新建pageState。
其中pageOutput在这一阶段只是一个占位符，空的nopPageOutput。
pageCommon则是在这一阶段给赋予了很多的信息，像meta相关的信息，及各种细节信息的providers。</p><h3 id=pagestate动手实践>PageState动手实践
<a class=anchor href=#pagestate%e5%8a%a8%e6%89%8b%e5%ae%9e%e8%b7%b5>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;html/template&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>outputFormats</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>createOutputFormats</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>renderFormats</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>initRenderFormats</span>(<span style=color:#a6e22e>outputFormats</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>site</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>outputFormats</span>: <span style=color:#a6e22e>outputFormats</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>renderFormats</span>: <span style=color:#a6e22e>renderFormats</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ps</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pageState</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pageOutputs</span>: <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pageOutput</span>:  <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pageCommon</span>:  <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pageCommon</span>{<span style=color:#a6e22e>m</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pageMeta</span>{<span style=color:#a6e22e>kind</span>: <span style=color:#a6e22e>KindPage</span>}},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>init</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// prepare
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>pageOutput</span> = <span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>pageOutputs</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// render
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>targetPaths</span>().<span style=color:#a6e22e>TargetFilename</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>Content</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>kind</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>site</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>outputFormats</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>Formats</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>renderFormats</span> <span style=color:#a6e22e>Formats</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pageState</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This slice will be of same length as the number of global slice of output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// formats (for all sites).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pageOutputs</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>pageOutput</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This will be shifted out when we start to render a new output format.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#f92672>*</span><span style=color:#a6e22e>pageOutput</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Common for all output formats.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#f92672>*</span><span style=color:#a6e22e>pageCommon</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pageState</span>) <span style=color:#a6e22e>init</span>(<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>site</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newPagePaths</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>pageOutputs</span> = make([]<span style=color:#f92672>*</span><span style=color:#a6e22e>pageOutput</span>, len(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>renderFormats</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>renderFormats</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ft</span>, <span style=color:#a6e22e>found</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>targetPaths</span>[<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Name</span>]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>found</span> {
</span></span><span style=display:flex><span>			panic(<span style=color:#e6db74>&#34;target path not found&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>providers</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>struct</span>{ <span style=color:#a6e22e>targetPather</span> }{<span style=color:#a6e22e>ft</span>}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>po</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pageOutput</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>f</span>:                      <span style=color:#a6e22e>f</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pagePerOutputProviders</span>: <span style=color:#a6e22e>providers</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ContentProvider</span>:        <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>contentProvider</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newPageContentOutput</span>(<span style=color:#a6e22e>po</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>po</span>.<span style=color:#a6e22e>ContentProvider</span> = <span style=color:#a6e22e>contentProvider</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>pageOutputs</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>po</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newPageContentOutput</span>(<span style=color:#a6e22e>po</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pageOutput</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>pageContentOutput</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cp</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pageContentOutput</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>f</span>: <span style=color:#a6e22e>po</span>.<span style=color:#a6e22e>f</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>initContent</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>content</span> = <span style=color:#a6e22e>template</span>.<span style=color:#a6e22e>HTML</span>(<span style=color:#e6db74>&#34;&lt;p&gt;hello content&lt;/p&gt;&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>initMain</span> = <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>initContent</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cp</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newPagePaths</span>(<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>site</span>) <span style=color:#a6e22e>pagePaths</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>outputFormats</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>renderFormats</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>targets</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>targetPathsHolder</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>outputFormats</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>target</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;blog&#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>BaseName</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>MediaType</span>.<span style=color:#a6e22e>SubType</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>paths</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>TargetPaths</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>TargetFilename</span>: <span style=color:#a6e22e>target</span>,
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>targets</span>[<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Name</span>] = <span style=color:#a6e22e>targetPathsHolder</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>paths</span>: <span style=color:#a6e22e>paths</span>,
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pagePaths</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>targetPaths</span>: <span style=color:#a6e22e>targets</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pagePaths</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>targetPaths</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>targetPathsHolder</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>targetPathsHolder</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>paths</span> <span style=color:#a6e22e>TargetPaths</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#a6e22e>targetPathsHolder</span>) <span style=color:#a6e22e>targetPaths</span>() <span style=color:#a6e22e>TargetPaths</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>paths</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pageOutput</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span> <span style=color:#a6e22e>Format</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// These interface provides the functionality that is specific for this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// output format.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pagePerOutputProviders</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ContentProvider</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// May be nil.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>cp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pageContentOutput</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// pageContentOutput represents the Page content for a given output format.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pageContentOutput</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>f</span>        <span style=color:#a6e22e>Format</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>initMain</span> <span style=color:#66d9ef>func</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>content</span>  <span style=color:#a6e22e>template</span>.<span style=color:#a6e22e>HTML</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pageContentOutput</span>) <span style=color:#a6e22e>Content</span>() <span style=color:#a6e22e>any</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>initMain</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>content</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// these will be shifted out when rendering a given output format.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pagePerOutputProviders</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>targetPather</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>targetPather</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>targetPaths</span>() <span style=color:#a6e22e>TargetPaths</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>TargetPaths</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Where to store the file on disk relative to the publish dir. OS slashes.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>TargetFilename</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ContentProvider</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Content</span>() <span style=color:#a6e22e>any</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pageCommon</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pageMeta</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pageMeta</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// kind is the discriminator that identifies the different page types
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// in the different page collections. This can, as an example, be used
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// to to filter regular pages, find sections etc.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Kind will, for the pages available to the templates, be one of:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// page, home, section, taxonomy and term.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// It is of string type to make it easy to reason about in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// the templates.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>kind</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>initRenderFormats</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>outputFormats</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>Formats</span>) <span style=color:#a6e22e>Formats</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>outputFormats</span>[<span style=color:#a6e22e>KindPage</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>createOutputFormats</span>() <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>Formats</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>Formats</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>KindPage</span>: {<span style=color:#a6e22e>HTMLFormat</span>},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>m</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>KindPage</span> = <span style=color:#e6db74>&#34;page&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>HTMLType</span> = <span style=color:#a6e22e>newMediaType</span>(<span style=color:#e6db74>&#34;text&#34;</span>, <span style=color:#e6db74>&#34;html&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// HTMLFormat An ordered list of built-in output formats.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>HTMLFormat</span> = <span style=color:#a6e22e>Format</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Name</span>:      <span style=color:#e6db74>&#34;HTML&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MediaType</span>: <span style=color:#a6e22e>HTMLType</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>BaseName</span>:  <span style=color:#e6db74>&#34;index&#34;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newMediaType</span>(<span style=color:#a6e22e>main</span>, <span style=color:#a6e22e>sub</span> <span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>Type</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Type</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>MainType</span>:  <span style=color:#a6e22e>main</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>SubType</span>:   <span style=color:#a6e22e>sub</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Delimiter</span>: <span style=color:#e6db74>&#34;.&#34;</span>}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>t</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Type</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MainType</span>  <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;mainType&#34;`</span>  <span style=color:#75715e>// i.e. text
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>SubType</span>   <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;subType&#34;`</span>   <span style=color:#75715e>// i.e. html
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Delimiter</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;delimiter&#34;`</span> <span style=color:#75715e>// e.g. &#34;.&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Format</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The Name is used as an identifier. Internal output formats (i.e. HTML and RSS)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// can be overridden by providing a new definition for those types.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Name</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MediaType</span> <span style=color:#a6e22e>Type</span> <span style=color:#e6db74>`json:&#34;-&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The base output file name used when not using &#34;ugly URLs&#34;, defaults to &#34;index&#34;.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>BaseName</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;baseName&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Formats</span> []<span style=color:#a6e22e>Format</span>
</span></span></code></pre></div><p>输出结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/blog/index.html
</span></span><span style=display:flex><span>&lt;p&gt;hello content&lt;/p&gt;
</span></span><span style=display:flex><span>page
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Program exited.
</span></span></code></pre></div><ul><li><a href=https://c.sunwei.xyz/page-state.html>PageState线上可直接运行版本</a></li></ul><h3 id=render>Render
<a class=anchor href=#render>#</a></h3><p>基础信息是由pageCommon提供了，那渲染过程中的输出由谁提供呢？</p><p>没错，轮到pageOutput了：</p><p><img src=images/13.6.3-Hugo-Sites-Build-pageState-render.svg alt="PageState Render"></p><p>可以看到，在render阶段，pageState的pageOutput得到了最终的处理，为发布做准备了。
为了发布，最重的信息是发布什么，以及发布到哪里去。
这些信息都在pageOutput中，其中ContentProvider是提供发布内容的，而targetPathsProvider则是提供发布地址信息的。
其中地址信息主要来源于PagePath，这又和站点的RenderFormats和OutputFormats相关，哪下图所示：</p><p><img src=images/13.6.1-Hugo-Sites-Build-pageState-structure.svg alt="PageState path structure"></p><p>其中OutputFormats, RenderFormats及PageOutput之间的关系有在
<a href=../how/%e5%9f%ba%e7%a1%80%e6%9e%b6%e6%9e%84.md>基础架构</a>中有详细提到，这里就不再赘述。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// We create a pageOutput for every output format combination, even if this
</span></span></span><span style=display:flex><span><span style=color:#75715e>// particular page isn&#39;t configured to be rendered to that format.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pageOutput</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// These interface provides the functionality that is specific for this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// output format.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pagePerOutputProviders</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>ContentProvider</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>TableOfContentsProvider</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>PageRenderProvider</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// May be nil.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>cp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pageContentOutput</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>其中pageContentOutput正是实现了ContentProvider接口的实例。
其中有包含markdown文件原始信息的workContent字段，以及包含处理过后的内容content字段。
如Hugo
<a href=https://gohugo.io/content-management/shortcodes/>Shortcode</a>特性。
就是在这里经过contentToRender方法将原始信息进行处理，而最终实现的。</p><h3 id=publish动手实践>Publish动手实践
<a class=anchor href=#publish%e5%8a%a8%e6%89%8b%e5%ae%9e%e8%b7%b5>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;bytes&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;io&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;path/filepath&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// publisher needs to know:
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 1: what to publish
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 2: where to publish
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// src is template executed result
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// it is the source that we need to publish
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// take a look at template executor example
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// https://c.sunwei.xyz/template-executor.html
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>src</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>src</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#e6db74>&#34;template executed result&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>{}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>transformers</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>createTransformerChain</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>transformers</span>.<span style=color:#a6e22e>Apply</span>(<span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>src</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dir</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>MkdirTemp</span>(<span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;hugo&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>RemoveAll</span>(<span style=color:#a6e22e>dir</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// targetPath is from pageState
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// this is where we need to publish
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// take a look at page state example
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// https://c.sunwei.xyz/page-state.html
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>targetPath</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>dir</span>, <span style=color:#e6db74>&#34;index.html&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>WriteFile</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>targetPath</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>TrimSuffix</span>(<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>Bytes</span>(), []byte(<span style=color:#e6db74>&#34;\n&#34;</span>)),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>ModePerm</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;1. what to publish: &#34;</span>, string(<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>Bytes</span>()))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;2. where to publish: &#34;</span>, <span style=color:#a6e22e>dir</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Chain</span>) <span style=color:#a6e22e>Apply</span>(<span style=color:#a6e22e>to</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Writer</span>, <span style=color:#a6e22e>from</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Reader</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fb</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fb</span>.<span style=color:#a6e22e>ReadFrom</span>(<span style=color:#a6e22e>from</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>tb</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ftb</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>fromToBuffer</span>{<span style=color:#a6e22e>from</span>: <span style=color:#a6e22e>fb</span>, <span style=color:#a6e22e>to</span>: <span style=color:#a6e22e>tb</span>}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>tr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>c</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			panic(<span style=color:#e6db74>&#34;switch from/to and reset to&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tr</span>(<span style=color:#a6e22e>ftb</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ftb</span>.<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>WriteTo</span>(<span style=color:#a6e22e>to</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>createTransformerChain</span>() <span style=color:#a6e22e>Chain</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>transformers</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewEmpty</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>transformers</span> = append(<span style=color:#a6e22e>transformers</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ft</span> <span style=color:#a6e22e>FromTo</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>content</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ft</span>.<span style=color:#a6e22e>From</span>().<span style=color:#a6e22e>Bytes</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ft</span>.<span style=color:#a6e22e>To</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>tc</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Replace</span>(
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>content</span>,
</span></span><span style=display:flex><span>			[]byte(<span style=color:#e6db74>&#34;result&#34;</span>), []byte(<span style=color:#e6db74>&#34;transferred result&#34;</span>), <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>tc</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>transformers</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Chain is an ordered processing chain. The next transform operation will
</span></span></span><span style=display:flex><span><span style=color:#75715e>// receive the output from the previous.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Chain</span> []<span style=color:#a6e22e>Transformer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Transformer is the func that needs to be implemented by a transformation step.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Transformer</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ft</span> <span style=color:#a6e22e>FromTo</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// FromTo is sent to each transformation step in the chain.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FromTo</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>From</span>() <span style=color:#a6e22e>BytesReader</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>To</span>() <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Writer</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// BytesReader wraps the Bytes method, usually implemented by bytes.Buffer, and an
</span></span></span><span style=display:flex><span><span style=color:#75715e>// io.Reader.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>BytesReader</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Bytes The slice given by Bytes is valid for use only until the next buffer modification.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// That is, if you want to use this value outside of the current transformer step,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// you need to take a copy.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Bytes</span>() []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Reader</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// NewEmpty creates a new slice of transformers with a capacity of 20.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewEmpty</span>() <span style=color:#a6e22e>Chain</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> make(<span style=color:#a6e22e>Chain</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Implements contentTransformer
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Content is 1.read from the from-buffer and rewritten to to the to-buffer.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>fromToBuffer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>from</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>to</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ft</span> <span style=color:#a6e22e>fromToBuffer</span>) <span style=color:#a6e22e>From</span>() <span style=color:#a6e22e>BytesReader</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ft</span>.<span style=color:#a6e22e>from</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ft</span> <span style=color:#a6e22e>fromToBuffer</span>) <span style=color:#a6e22e>To</span>() <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Writer</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ft</span>.<span style=color:#a6e22e>to</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>输出结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>1. what to publish:  template executed transferred result
</span></span><span style=display:flex><span>2. where to publish:  /tmp/hugo2834984546
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Program exited.
</span></span></code></pre></div><ul><li><a href=https://c.sunwei.xyz/publisher.html>Publish线上可直接运行版本</a></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/sunwei/hugo-notes/commit/1d95a266b0290ad7b3b4459d6bd478659f3d12e9 title='最后修改者 sunwei | November 20, 2023' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>November 20, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/sunwei/hugo-notes/edit/main/content.zh/docs/chapter/03/code/build/_index.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>编辑本页</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#build源码分析>Build源码分析</a><ul><li><a href=#build时序图>Build时序图</a><ul><li><a href=#process时序图>Process时序图</a></li><li><a href=#process动手实践>process动手实践</a></li><li><a href=#assemble>Assemble</a></li><li><a href=#pagestate>PageState</a></li><li><a href=#pagestate动手实践>PageState动手实践</a></li><li><a href=#render>Render</a></li><li><a href=#publish动手实践>Publish动手实践</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>