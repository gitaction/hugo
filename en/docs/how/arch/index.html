<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Hugo Architecture # We can learn how to use Hugo to create our own sites and theme. Here are examples: Personal Site and Custom Theme. It is easy to learn and use.
At the same time, Hugo is an open source project based on the Apache 2.0 protocol, which means that you can boldly use your creativity.
For example, for sites in the source code field, such as Understanding Hugo in Depth, the source code and notes are separated and can be executed on GolangPlay."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content><meta property="og:description" content="Hugo Architecture # We can learn how to use Hugo to create our own sites and theme. Here are examples: Personal Site and Custom Theme. It is easy to learn and use.
At the same time, Hugo is an open source project based on the Apache 2.0 protocol, which means that you can boldly use your creativity.
For example, for sites in the source code field, such as Understanding Hugo in Depth, the source code and notes are separated and can be executed on GolangPlay."><meta property="og:type" content="article"><meta property="og:url" content="https://hugo.notes.sunwei.xyz/en/docs/how/arch/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-02-09T20:30:54+08:00"><title>Index | Deep Dive into Hugo: Becoming an Expert in the Static Site Generator Domain</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css integrity="sha256-xYKS02sYtnVoCrm66iApIEU3uDnqcvJYdG7A8yzo1sg=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.8ffc7540214fa0ea1be60156a809a9db2d8cf47717975e521b4dac9ba78aecb6.js integrity="sha256-j/x1QCFPoOob5gFWqAmp2y2M9HcXl15SG02sm6eK7LY=" crossorigin=anonymous></script>
<script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-STPKPBQR5Y"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-STPKPBQR5Y",{anonymize_ip:!1})}</script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/en/><span>Deep Dive into Hugo: Becoming an Expert in the Static Site Generator Domain</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul class=book-languages><li><input type=checkbox id=languages class=toggle>
<label for=languages class="flex justify-between"><a role=button class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
English</a></label><ul><li><a href=https://hugo.notes.sunwei.xyz/>Chinese</a></li></ul></li></ul><ul><li><p><strong>Hugo usage examples</strong></p></li><li><p><a href=/en/docs/what/site/>Create Site</a></p></li><li><p><a href=/en/docs/what/theme/>Custom Theme</a><br></p></li><li><p><strong>Hugo Architecture</strong></p></li><li><p><a href=/en/docs/how/playground/>Playground</a></p></li><li><p><a href=/en/docs/how/event-storming/>Event Storming</a></p></li><li><p><a href=/en/docs/how/arch/ class=active>Architecture</a><br></p></li><li><p><a href=/en/docs/code/><strong>Source Code</strong></a></p></li><li><p><a href=/en/docs/code/config/>Configuration</a></p></li><li><p><a href=/en/docs/code/deps/>Deps Management</a></p><ul><li><a href=/en/docs/code/deps/pathspec/>PathSpec</a></li><li><a href=/en/docs/code/deps/contentspec/>ContentSpec</a></li></ul></li><li><p><a href=/en/docs/code/site/>Site Creating</a></p><ul><li><a href=/en/docs/code/site/create/>Create Site</a></li><li><a href=/en/docs/code/site/resources/>Load Resources</a></li><li><a href=/en/docs/code/site/markdown/>Markdown</a></li></ul></li><li><p><a href=/en/docs/code/build/>Site Building</a></p><ul><li><a href=/en/docs/code/build/template/>Template Exec</a><br></li></ul></li></ul><ul><li><a href=/en/posts/>Blog</a></li><li><a href=https://github.com/sunwei/hugo-book target=_blank rel=noopener>Github</a></li><li><a href=https://themes.gohugo.io/hugo-book/ target=_blank rel=noopener>Hugo Themes</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Index</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#hugo-architecture>Hugo Architecture</a><ul><li><a href=#architecture-design-of-hugo>Architecture Design of Hugo</a><ul><li><a href=#configuration-module>Configuration Module</a></li><li><a href=#hugosites-module>HugoSites Module</a></li><li><a href=#deps-module>Deps Module</a></li></ul></li><li><a href=#hugos-component-design>Hugo&rsquo;s component design</a><ul><li><a href=#the-relationship-between-configuration-and-language>The relationship between configuration and language</a></li><li><a href=#configprovider>config.Provider</a></li><li><a href=#depscfg>DepsCfg</a></li><li><a href=#hugo-modules>Hugo modules</a></li></ul></li><li><a href=#organization-of-the-file-system>Organization of the file system</a><ul><li><a href=#afero>Afero</a></li><li><a href=#fs-in-hugo-architecture>Fs in Hugo architecture</a></li><li><a href=#hugofs>HugoFs</a></li><li><a href=#pathspec>PathSpec</a></li><li><a href=#basefs>BaseFs</a></li><li><a href=#sourcefilesystems>SourceFilesystems</a></li><li><a href=#thebigfs>theBigFs</a></li><li><a href=#file-system-scenario-1---contentspec>File system scenario 1 - ContentSpec</a></li><li><a href=#file-system-scenario-2---loadtemplates>File system scenario 2 - loadTemplates</a></li></ul></li><li><a href=#site-content-collection-solutions>Site content collection solutions</a><ul><li><a href=#sharpening-a-knife-does-not-delay-woodcutters>Sharpening a knife does not delay woodcutters</a></li><li><a href=#clear-division-of-labor-and-efficient-collaboration>Clear division of labor and efficient collaboration</a></li></ul></li><li><a href=#template-lifecycle>Template Lifecycle</a><ul><li><a href=#hugo-template-lifecycle-domain-events>Hugo Template Lifecycle Domain Events</a></li><li><a href=#summary>summary</a></li></ul></li><li><a href=#publish-process>Publish process</a><ul><li><a href=#publishing-process-for-independent-pages>Publishing process for independent pages</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=hugo-architecture>Hugo Architecture
<a class=anchor href=#hugo-architecture>#</a></h1><p>We can learn how to use Hugo to create our own sites and theme.
Here are examples:
<a href=https://hugo.notes.sunwei.xyz/s/what/site/>Personal Site</a> and
<a href=https://hugo.notes.sunwei.xyz/en/docs/what/theme/>Custom Theme</a>.
It is easy to learn and use.</p><p>At the same time, Hugo is an open source project based on the Apache 2.0 protocol, which means that you can boldly use your creativity.</p><p>For example, for sites in the source code field, such as
<a href=https://c.sunwei.xyz/>Understanding Hugo in Depth</a>, the source code and notes are separated and can be executed on
<a href=https://go.dev/play/>GolangPlay</a>.
Make the learning experience of source code more three-dimensional, not only have interpretation, but also participate in it, modify the example to further help understanding.</p><p>At present, Hugo cannot support the construction of such a site for two main reasons.
The first reason is
<a href=https://gohugo.io/content-network/formats/>Content Format</a>.
The content format currently supported by Hugo is Markdown, and the above content format is .go source code file.
The second reason is
<a href=https://gohugo.io/functions/>Functions</a>.
Hugo does not have a function that handles code and can be used directly.
To parse the source code and notes.
Although the string function can be combined for processing, it is cumbersome to use, difficult to expand, and even more impressive to maintain.</p><p>But we have the source codes.
Can we ask for more?
After all, we are software engineers in pursuit!</p><p>Whether it is from a practical perspective or from the perspective of learning excellent sources to communicate and learn, we have every reason to explore this treasure.</p><p>The goal of this chapter is to open the Treasure Map to understand the infrastructure of the Hugo, which is mainly carried out in the following two directions:</p><ul><li><p>Provides an overview of the architectural thinking and a comprehensive understanding of the infrastructure</p></li><li><p>Start with module code and discuss the relationship between configuration and language, Hugo modules, organization of file systems, collection of site content, lifecycle of templates, and publishing processes.</p></li><li><p>By reading this chapter, we will have a comprehensive understanding of the Hugo site construction tool and a clear understanding of the relationship between the stages, laying a foundation for the next detailed source implementation chapters.</p></li></ul><p>Let&rsquo;s go, great engineer!</p><h2 id=architecture-design-of-hugo>Architecture Design of Hugo
<a class=anchor href=#architecture-design-of-hugo>#</a></h2><p>Combining the Hugo site construction domain
<a href=https://hugo.notes.sunwei.xyz//en/docs/how/event-storming/>event</a>,
and
<a href=https://github.com/sun.com/hugo-playground>Hugo playground</a> source code, the architecture design of Hugo will become very clear:</p><p><img src=images/3.0-hugo-arch.svg alt="Hugo Arch"></p><p>Hugo&rsquo;s architecture idea is easy to understand.
It is mainly divided into three major blocks: configuration module, site module and dependency module.</p><h3 id=configuration-module>Configuration Module
<a class=anchor href=#configuration-module>#</a></h3><p>The first thing Hugo parses is the configuration file <code>config.toml</code> of the user project.
Initiated by <code>configLoader</code>, the configuration file is read from the hard disk and stored as a key-value pair object after parsing.</p><p><code>configLoader</code> mainly needs to complete three things:</p><ol><li>Load the user project configuration file to understand the user&rsquo;s custom requirements.</li><li>Complete the default configuration <code>Defaults Config</code>, to ensure the normal operation of other modules.</li><li>Generate module configuration information, starting from the user project, using the user project as the first module - <code>project module</code>, and in our example there is a second module, that is the theme module <code>mytheme</code>.</li></ol><p>There are dependencies between modules and there is only one Owner <code>Owner</code>.
The project module <code>project module</code> is special, because it is the initial module, so it does not belong to any other modules.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Module</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Owner In the dependency tree, this is the first 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// module that defines this module as a dependency.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Owner</span>() <span style=color:#a6e22e>Module</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After all the information is collected, the <code>config.Provider</code> service will be provided externally: it can be queried and configuration items can be updated.</p><h3 id=hugosites-module>HugoSites Module
<a class=anchor href=#hugosites-module>#</a></h3><p>This is the core module of building a site, which is equivalent to the aggregate root in DDD.
It organizes all the information needed to build a site internally and provides site building services externally.</p><p>The initialization of <code>HugoSites</code> depends on <code>DepsCfg</code> and <code>Site</code>, yes, there are two sites.
The relationship between HugoSites and Site is one-to-many, and the relationship between Site and Language is one-to-one,
so a multilingual site will create a site for each language, which together form HugoSites.</p><p>Language items are created by DepsCfg, but will be stored in <code>config.Provider</code>, so they are marked in light yellow.
The initialization of DepsCfg depends on <code>Fs</code> and <code>config.Provider</code>.
<code>Fs</code> records the source file address and release address.
The source files come from the user project, which is the actual hard disk file system.
The publishing address is obtained from config.Provider, and the default is the public folder.
It will check whether it already exists here, and create it actively if not.
Finally, synchronize the newly created information such as <code>workingDir</code> back to config.Provider.</p><p>As can be seen, their dependencies are <code>HugoSites &lt;- Site &lt;- Language &lt;- DepsCfg &lt;- Fs</code>.</p><h3 id=deps-module>Deps Module
<a class=anchor href=#deps-module>#</a></h3><p>Hugo refers to all the services and objects needed to build a site as dependencies, and puts them all in <code>Deps</code>.</p><p>In the process of building dependencies, <code>TemplateProvider</code> that provides templates will be generated;
Clear input and output media type <code>MediaType</code>; and output format <code>OutputFormats</code>;
will be updated to <code>config.Provider</code>.</p><p>It will also be prepared for collecting site content, and there will be a <code>Page Collection</code> to help collect.
The publishing service that needs to be used when finally publishing the site is <code>Publisher</code>.
These will be updated to <code>Site</code>.</p><p>At the same time, it is also necessary to manage resources in a unified manner with clear specifications,
which can ensure the convenience of use and conform to the principle of single responsibility in the principle of oriented design.
Contains <code>Path Spec</code> that provides a unified standard file structure service;
and a <code>Resources Spec</code> with all media type and output format information;
and a <code>Content Spec</code> that provides services for <code>Content</code> information;
Plus <code>Source Spec</code> to help define resource policies, such as filtering functions.</p><p>With the help of Deps, all the information needed to build the site, such as raw materials, rules,
and output formats, etc., are prepared.</p><p>All is ready except for the opportunity!</p><h2 id=hugos-component-design>Hugo&rsquo;s component design
<a class=anchor href=#hugos-component-design>#</a></h2><p>The architecture diagram can help us understand Hugo&rsquo;s architecture design from a global perspective.
Now let&rsquo;s go a step closer and look at the details of Hugo&rsquo;s architecture from a module perspective</p><h3 id=the-relationship-between-configuration-and-language>The relationship between configuration and language
<a class=anchor href=#the-relationship-between-configuration-and-language>#</a></h3><p>Hugo provides powerful configuration features, such as configuration files, configuration directories,
configuration themes, and more.
In the process of building a site, as long as it is a customized requirement that you can think of,
it can basically be realized through configuration.</p><p>In order to meet different customization needs,
Hugo&rsquo;s idea is to deal with the relationship between many configuration files first,
so some configuration items need to be merged, which requires case insensitivity.
Customization is only a small part, and other general information is explained with the default configuration.</p><p>Supporting multiple languages is a common requirement,
and the strategy followed by much software is to give priority to internationalization.
So how does Hugo understand the relationship between language and configuration?</p><p>In the
<a href=https://hugo.notes.sunwei.xyz/en/docs/what/site/>personal site</a> example,
we configure language-related configurations in <code>config.toml</code> as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#a6e22e>defaultContentLanguage</span> = <span style=color:#e6db74>&#39;zh&#39;</span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>languages</span>]
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>languages</span>.<span style=color:#a6e22e>zh</span>]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>languageName</span> = <span style=color:#e6db74>&#39;中文&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>contentDir</span> = <span style=color:#e6db74>&#39;content&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>weight</span> = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>languages</span>.<span style=color:#a6e22e>en</span>]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>languageName</span> = <span style=color:#e6db74>&#39;English&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>contentDir</span> = <span style=color:#e6db74>&#39;content.en&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>weight</span> = <span style=color:#ae81ff>2</span>
</span></span></code></pre></div><p>The default language can be configured, and the supported languages are Chinese and English.</p><p>From this point of view, the configuration should include the language.
In other words, the language should be a field in the configuration structure.
And is this the case?
Let&rsquo;s start from the source code of
<a href=https://github.com/sunwei/hugo-playground>Hugo Playground</a> to find out.</p><p>Before that, let&rsquo;s look for clues from the architecture diagram:
<img src=images/3.1-hugo-arch-config-language.svg alt="Language and Config"></p><p>It can be seen that the place where Language is finally created is in DepsCfg, not Config.
This is counter to our intuition, let&rsquo;s take a look at the key config.Provider, DepsCfg and Language related code snippets.</p><h3 id=configprovider>config.Provider
<a class=anchor href=#configprovider>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Provider provides the configuration settings for Hugo.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Provider</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>any</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#a6e22e>any</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It can be seen that the Provider interface provides <code>Get</code> and <code>Set</code> methods, just like a key/value warehouse.
The language-related configuration is also stored in the Provider.</p><h3 id=depscfg>DepsCfg
<a class=anchor href=#depscfg>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// DepsCfg contains configuration options that can be used to configure Hugo
</span></span></span><span style=display:flex><span><span style=color:#75715e>// on a global level, i.e. logging etc.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Nil values will be given default values.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DepsCfg</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The language to use.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Language</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>langs</span>.<span style=color:#a6e22e>Language</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The configuration to use.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Cfg</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Provider</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>DepsCfg contains config.Provider and Language.</p><p>When creating a site, the direct input is DepsCfg:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// newSite creates a new site with the given configuration.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newSite</span>(<span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>deps</span>.<span style=color:#a6e22e>DepsCfg</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>Site</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Before calling to create a site, DepsCfg has already prepared Language:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>createSitesFromConfig</span>(<span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>deps</span>.<span style=color:#a6e22e>DepsCfg</span>) ([]<span style=color:#f92672>*</span><span style=color:#a6e22e>Site</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>languages</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getLanguages</span>(<span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Cfg</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>lang</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>languages</span> {
</span></span><span style=display:flex><span>		<span style=color:#f92672>...</span> 
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Language</span> = <span style=color:#a6e22e>lang</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>newSite</span>(<span style=color:#a6e22e>cfg</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sites</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>From the Language structure, it can be seen that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Language manages specific-language configuration.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Language</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Lang</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Weight</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>// for sort
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Global config.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// For internal use.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Cfg</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Provider</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Language contains Cfg config.Provider.
That is to say, the relationship between Language and Config is actually an inclusive relationship, not as we felt above.
Think about it carefully, it makes sense.
Config focuses on providing configuration key/value warehouse management services,
while Language and Site are in one-to-one correspondence, and additional configuration information is required.</p><h3 id=hugo-modules>Hugo modules
<a class=anchor href=#hugo-modules>#</a></h3><p>When it comes to modularization, you may think of Nginx modules, IDEA plug-ins and so on.
Usually, I can meet my differentiated needs by uploading some modules.
The reason why everyone likes this kind of module is mainly because it is flexible enough to meet their own needs without too much effort.
Because many times, although they are roughly the same, there are always some differences in details.
This also shows the complexity of software, in addition to technical complexity, there is also business complexity.
In most cases, what we are facing is mainly business complexity.
This is also the best explanation of the saying &ldquo;interlacing lines are like mountains&rdquo; in the field of software.
Nowadays, not only the Internet industry, the financial industry,
but also the traditional manufacturing industry have used information systems to help enterprises in production and management.
The same leave application system, even in the same industry and different companies, will be different.</p><p>However, Hugo&rsquo;s modules are a bit different from the modules in everyone&rsquo;s impression.
They do not use functions as units to meet differentiated needs.
Instead, the directory structure is used to identify the same structure.</p><p>Let&rsquo;s take a look at the location of the module in our architecture:</p><p><img src=images/3.2-hugo-arch-module.svg alt="Hugo Arch Module"></p><p>In the architecture diagram, <code>Modules</code> needs to be organized in a unified manner,
relying on the description information of <code>Modules Config</code>,
and the loading of this information is the responsibility of configLoader.</p><p>Let&rsquo;s take a look at the actual call timing from the source code of
<a href=https://github.com/sunwei/hugo-playground>Hugo Playground</a>:</p><p><img src=images/3.2.1-hugo-arch-module.svg alt="Hugo Arch Module flow"></p><p>It can be seen that in our playground, the main function calls the <code>LoadConfig</code> method,
and does two things for <code>Modules</code> in this method.
One is <code>loadModulesConfig</code>, which organizes configuration information related to Modules into Module Config.
The other is <code>collectModules</code>, which standardizes the module information according to the module standard according to the collected configuration information.</p><p>Let&rsquo;s take a look at the source code definition of <code>Module Config</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Config holds a module config.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Config</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Mounts</span>  []<span style=color:#a6e22e>Mount</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Imports</span> []<span style=color:#a6e22e>Import</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Meta info about this module (license information etc.).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Params</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It can be seen that there are two important fields, one is Mounts and the other is Imports.
<code>loadModulesConfig</code> mainly deals with the Imports field, in our example:</p><pre tabindex=0><code>-- config.toml --
theme = &#34;mytheme&#34;
...
</code></pre><p>The configuration information of the theme is <code>theme = "mytheme"</code>,
and when parsed into module configuration information, it becomes <code>c.Imports = [mytheme]</code>.</p><p>The next step is to collect the module <code>collectModules</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#a6e22e>configLoader</span>) <span style=color:#a6e22e>collectModules</span>(<span style=color:#a6e22e>modConfig</span> <span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>Config</span>, <span style=color:#f92672>...</span>) (<span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>Modules</span>, <span style=color:#f92672>...</span>) {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Pass in the module configuration information just collected, and output standard module information.
However, the configuration information we just collected has only Imports and only one value &ldquo;mytheme&rdquo;.
The output example is shown in the following figure:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%#v\n&#34;</span>, <span style=color:#a6e22e>modulesConfig</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Mounts</span>:[]<span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>Mount</span>(<span style=color:#66d9ef>nil</span>), 
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Imports</span>:[]<span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>Import</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>Import</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Path</span>:<span style=color:#e6db74>&#34;mytheme&#34;</span>, 
</span></span><span style=display:flex><span>			<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	}}, 
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Params</span>:<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span> {}(<span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>**Why does Hugo call Theme a module? **</p><p>Enter the following command to create a site:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>➜  tmp hugo new site xyz
</span></span></code></pre></div><p>查看目录结构：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>➜  xyz tree
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── archetypes
</span></span><span style=display:flex><span>│   └── default.md
</span></span><span style=display:flex><span>├── config.toml
</span></span><span style=display:flex><span>├── content
</span></span><span style=display:flex><span>├── data
</span></span><span style=display:flex><span>├── layouts
</span></span><span style=display:flex><span>├── public
</span></span><span style=display:flex><span>├── static
</span></span><span style=display:flex><span>└── themes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>7</span> directories, <span style=color:#ae81ff>2</span> files
</span></span></code></pre></div><p>Then enter the following command to create a theme:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>➜  tmp hugo new theme mytheme
</span></span></code></pre></div><p>Also look at the directory structure:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>➜  mytheme tree
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── LICENSE
</span></span><span style=display:flex><span>├── archetypes
</span></span><span style=display:flex><span>│   └── default.md
</span></span><span style=display:flex><span>├── layouts
</span></span><span style=display:flex><span>│   ├── 404.html
</span></span><span style=display:flex><span>│   ├── _default
</span></span><span style=display:flex><span>│   │   ├── baseof.html
</span></span><span style=display:flex><span>│   │   ├── list.html
</span></span><span style=display:flex><span>│   │   └── single.html
</span></span><span style=display:flex><span>│   ├── index.html
</span></span><span style=display:flex><span>│   └── partials
</span></span><span style=display:flex><span>│       ├── footer.html
</span></span><span style=display:flex><span>│       ├── head.html
</span></span><span style=display:flex><span>│       └── header.html
</span></span><span style=display:flex><span>├── static
</span></span><span style=display:flex><span>│   ├── css
</span></span><span style=display:flex><span>│   └── js
</span></span><span style=display:flex><span>└── theme.toml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>7</span> directories, <span style=color:#ae81ff>11</span> files
</span></span></code></pre></div><p>Let&rsquo;s compare the directory structures of Site and Theme together:</p><p><img src=images/3.2.2-hugo-arch-site-theme-folder-struct.png alt="Hugo Arch Modules site and theme folder structure"></p><p>By comparison, it is not difficult to find that the directory structure is basically the same,
including <code>archetypes</code>, <code>layouts</code>, <code>static</code> and so on.</p><p>On the Hugo official website, there is a clear description of
<a href=https://gohugo.io/getting-started/directory-structure/>directory structure</a>.
You can also see from the source code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// hugo-playground/hugofs/files/classifier.go
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ComponentFolderArchetypes</span> = <span style=color:#e6db74>&#34;archetypes&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ComponentFolderStatic</span>     = <span style=color:#e6db74>&#34;static&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ComponentFolderLayouts</span>    = <span style=color:#e6db74>&#34;layouts&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ComponentFolderContent</span>    = <span style=color:#e6db74>&#34;content&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ComponentFolderData</span>       = <span style=color:#e6db74>&#34;data&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ComponentFolderAssets</span>     = <span style=color:#e6db74>&#34;assets&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ComponentFolderI18n</span>       = <span style=color:#e6db74>&#34;i18n&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ComponentFolders</span> = []<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ComponentFolderArchetypes</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ComponentFolderStatic</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ComponentFolderLayouts</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ComponentFolderContent</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ComponentFolderData</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ComponentFolderAssets</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ComponentFolderI18n</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>It can be seen that Hugo makes each module follow this unified principle by standardizing the directory structure,
so that there are rules to follow no matter when parsing themes or user projects.</p><p>Take a look at Hugo&rsquo;s description of
<a href=https://gohugo.io/hugo-modules/configuration/>module</a>:</p><blockquote><p>Hugo Modules are the core building blocks in Hugo.
A module can be your main project or a smaller module providing
one or more of the 7 component types defined in Hugo:
static, content, layouts, data, assets, i18n, and archetypes.</p></blockquote><p>That is to say <code>static, content, layouts, data, assets, i18n, and archetypes</code>
Any combination of these 7 components is considered to meet the requirements of the module.</p><p>Hugo&rsquo;s modules are built on top of Go Modules and are easy to use:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>module</span>]
</span></span><span style=display:flex><span>[[<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>imports</span>]]
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>path</span> = <span style=color:#e6db74>&#39;github.com/sunwei/zero&#39;</span>
</span></span></code></pre></div><p>That is to say, we can now load the theme in the form of loading modules,
instead of importing the theme as a git submodule, which is more convenient and reasonable.</p><p>After figuring out why the theme is also a module,
let&rsquo;s take a look at the final configuration information of the module we got:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// hugo-playground/hugolib/config.go 
</span></span></span><span style=display:flex><span><span style=color:#75715e>// line 140
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Process</span>(<span style=color:#e6db74>&#34;collectModules&#34;</span>, <span style=color:#e6db74>&#34;set active modules to config with key &#39;allModules&#39;&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>moduleConfig</span>.<span style=color:#a6e22e>ActiveModules</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%#v\n&#34;</span>, <span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Output</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>==</span>&gt; <span style=color:#a6e22e>Process</span> <span style=color:#a6e22e>collectModules</span>: <span style=color:#a6e22e>set</span> <span style=color:#a6e22e>active</span> <span style=color:#a6e22e>modules</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>config</span> <span style=color:#a6e22e>with</span> <span style=color:#a6e22e>key</span> <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>allModules</span><span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&amp;</span><span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>moduleAdapter</span>{<span style=color:#a6e22e>path</span>:<span style=color:#e6db74>&#34;project&#34;</span>, <span style=color:#f92672>...</span> <span style=color:#a6e22e>projectMod</span>:<span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>owner</span>:<span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>Module</span>(<span style=color:#66d9ef>nil</span>), 
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mounts</span>:[]<span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>Mount</span>{
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>Mount</span>{<span style=color:#a6e22e>Source</span>:<span style=color:#e6db74>&#34;mycontent&#34;</span>, <span style=color:#a6e22e>Target</span>:<span style=color:#e6db74>&#34;content&#34;</span>, <span style=color:#a6e22e>Lang</span>:<span style=color:#e6db74>&#34;en&#34;</span>}, 
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>Mount</span>{<span style=color:#a6e22e>Source</span>:<span style=color:#e6db74>&#34;data&#34;</span>, <span style=color:#a6e22e>Target</span>:<span style=color:#e6db74>&#34;data&#34;</span>, <span style=color:#a6e22e>Lang</span>:<span style=color:#e6db74>&#34;&#34;</span>}, 
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>Mount</span>{<span style=color:#a6e22e>Source</span>:<span style=color:#e6db74>&#34;layouts&#34;</span>, <span style=color:#a6e22e>Target</span>:<span style=color:#e6db74>&#34;layouts&#34;</span>, <span style=color:#a6e22e>Lang</span>:<span style=color:#e6db74>&#34;&#34;</span>}, 
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>Mount</span>{<span style=color:#a6e22e>Source</span>:<span style=color:#e6db74>&#34;i18n&#34;</span>, <span style=color:#a6e22e>Target</span>:<span style=color:#e6db74>&#34;i18n&#34;</span>, <span style=color:#a6e22e>Lang</span>:<span style=color:#e6db74>&#34;&#34;</span>}, 
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>Mount</span>{<span style=color:#a6e22e>Source</span>:<span style=color:#e6db74>&#34;archetypes&#34;</span>, <span style=color:#a6e22e>Target</span>:<span style=color:#e6db74>&#34;archetypes&#34;</span>, <span style=color:#a6e22e>Lang</span>:<span style=color:#e6db74>&#34;&#34;</span>}, 
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>Mount</span>{<span style=color:#a6e22e>Source</span>:<span style=color:#e6db74>&#34;assets&#34;</span>, <span style=color:#a6e22e>Target</span>:<span style=color:#e6db74>&#34;assets&#34;</span>, <span style=color:#a6e22e>Lang</span>:<span style=color:#e6db74>&#34;&#34;</span>}, 
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>Mount</span>{<span style=color:#a6e22e>Source</span>:<span style=color:#e6db74>&#34;static&#34;</span>, <span style=color:#a6e22e>Target</span>:<span style=color:#e6db74>&#34;static&#34;</span>, <span style=color:#a6e22e>Lang</span>:<span style=color:#e6db74>&#34;&#34;</span>}}, <span style=color:#f92672>...</span>}
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&amp;</span><span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>moduleAdapter</span>{<span style=color:#a6e22e>path</span>:<span style=color:#e6db74>&#34;mytheme&#34;</span>, <span style=color:#f92672>...</span> <span style=color:#a6e22e>projectMod</span>:<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>owner</span>:(<span style=color:#f92672>*</span><span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>moduleAdapter</span>)(<span style=color:#ae81ff>0xc00019e410</span>), 
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mounts</span>:[]<span style=color:#a6e22e>modules</span>.<span style=color:#a6e22e>Mount</span>(<span style=color:#66d9ef>nil</span>), <span style=color:#f92672>...</span>}
</span></span></code></pre></div><p>From the output results, there are two modules in total, one is <code>project</code> and the other is <code>mytheme</code>.
Because in our example, <code>mytheme</code> has only one txt file, none of the seven components,
so the mounts are empty, and the project module has Mounts for each component.</p><p>Hugo implements Hugo Module through a clever standardized directory structure design.
Strong scalability and convenience allow users to focus on content creation, and personalization is also greatly satisfied.</p><h2 id=organization-of-the-file-system>Organization of the file system
<a class=anchor href=#organization-of-the-file-system>#</a></h2><p>Currently, the main operations of Hugo are performed on local files.
For example, read configuration information, template information, blog content, write site information, and so on.
Because these operations are inseparable from the file system,
Hugo has done a lot of work on the organization of file information to ensure a good user experience for the caller.</p><h3 id=afero>Afero
<a class=anchor href=#afero>#</a></h3><p>The first is to select the basic file system
<a href=https://github.com/spf13/afero>afero.Fs</a>:</p><blockquote><p>Afero is a filesystem framework providing a simple,
uniform and universal API interacting with any filesystem,
as an abstraction layer providing interfaces, types and methods.
Afero has an exceptionally clean interface and simple design without needless
constructors or initialization methods.</p></blockquote><p>The services provided by Afero are basically consistent with Golang&rsquo;s native Fs interface,
and secondly, it is compatible with multiple operating systems, so that it is compatible with both languages and systems,
and the user experience is also consistent with the original.
does provide a good file system foundation for Hugo.</p><p>In order to visually view the association of various Fs in Hugo,
we mark afero.Fs as the following structure, including basic operation examples of the file system:</p><p><img src=images/4.1-hfs-afero.Fs.svg alt="Hugo FS afero.Fs"></p><h3 id=fs-in-hugo-architecture>Fs in Hugo architecture
<a class=anchor href=#fs-in-hugo-architecture>#</a></h3><p>Let&rsquo;s review the scenario of Fs application in the Hugo architecture:</p><p><img src=images/4.0-hugo-arch-fs.svg alt="Hugo Arch Fs"></p><p>The first thing to appear is Fs, which is used to record the file system closest to the real directory.
As a parameter of DpesCfg, when HugoSites creates Deps, it is transparently passed to Deps.
Deps is the module that really organizes and builds the entire file system,
and finally uses PathSpec to organize the previous original file system into the file system required by Hugo.
Finally, it is used for Template and Page related operations.</p><h3 id=hugofs>HugoFs
<a class=anchor href=#hugofs>#</a></h3><p>Let&rsquo;s first look at the basic Fs, which is HugoFs:</p><p><img src=images/4.2-hgf-hugoFs.svg alt="Hugo Fs hugoFs"></p><p>It can be seen that the basic hugoFs includes the input Source,
the output target address PublishDir, and the WorkingDir for read-only.
And the first item is of type afero.Fs, so the color is the same as that of afero.Fs.
Colors will also be used later to associate different types of file systems.</p><h3 id=pathspec>PathSpec
<a class=anchor href=#pathspec>#</a></h3><p>From the above Hugo architecture diagram, we know that HugoFs is finally passed into Dpes,
and PathSpec is used to organize and manage all path-related information in a unified way:</p><p><img src=images/4.3-hfs-PathSpec.svg alt="Hugo Fs PathSpec"></p><p>It can be seen from the above figure that PathSpec contains hugoFs and Paths, and there is another important BaseFs.</p><p>Let’s look at Paths first, which includes the basic file system,
theme and working directory information, and Modules-related information.
Based on Fs and Path, PathSpec needs to digest these basic information and provide complete file system services.</p><h3 id=basefs>BaseFs
<a class=anchor href=#basefs>#</a></h3><p>Through the prepared basic information hugoFs and Paths, BaseFs not only provides some basic services,
such as source file system and release target file system, and related information such as working directory.
It is also necessary to organize the files according to the basic directories required by Hugo,
such as Content, Data, i18n, Layouts, Archetypes, Assets.
And it is required to strictly follow the module loading order to provide the final file service.
For example, when the user adds some templates in the project directory and needs to overwrite the templates that come with the theme.</p><p><img src=images/4.4-hfs-BaseFs.svg alt="Hugo Fs BaseFs"></p><p>As shown in the figure above, BaseFs uses SourceFilesystems to organize the basic directory,
and uses theBigFs to provide the final merged file system service.</p><h3 id=sourcefilesystems>SourceFilesystems
<a class=anchor href=#sourcefilesystems>#</a></h3><p><img src=images/4.5-hfs-SourceFilesystems.svg alt="Hugo Fs SourceFilesystems"></p><p>In order to map out the basic file structure of Hugo,
Hugo designed the corresponding structure SourceFilesystems to represent, and use fields to correspond one by one.
Each item has a common feature, namely SourceFilesystem.</p><p>大家可以回忆下，在上一节
<a href=/en/#hugo%e7%9a%84%e6%a8%a1%e5%9d%97>Hugo的模块</a>中有提到，每一个模块是如何在Mount中存储这些信息的。
You can recall that in the previous section
<a href=https://hugo.notes.sunwei.xyz/en/docs/how/arch/#hugo-modules>Hugo&rsquo;s module</a>,
it was mentioned how each module stores this information in Mount.</p><h3 id=thebigfs>theBigFs
<a class=anchor href=#thebigfs>#</a></h3><p><img src=images/4.6-hgs-theBigFs.svg alt="Hugo Fs theBigFs"></p><p>Multiple modules will generate multiple file systems with the same structure,
who is in the front and who is in the back is determined by the module configuration information.
So how do you end up merging these filesystems?
As can be seen from the figure above, the answer given by Hugo is Overlay.
For the working principle, please refer to
<a href=https://zh.wikipedia.org/wiki/OverlayFS>Wikipedia OverlayFS</a>.</p><p>The organization of the Overlay is carried out by the filesystemCollector,
and the file metadata FileMetaInfo is used to describe it, which is convenient for related file operations,
such as query and sorting.
Before generating the Overlay view of the final state,
RootMappingFs is needed to help organize the file system classified by Content, Static, etc.
Finally, the Collector will put the corresponding files into the corresponding collection.</p><p>With the above organized file systems, think about the possible use scenarios?</p><h3 id=file-system-scenario-1---contentspec>File system scenario 1 - ContentSpec
<a class=anchor href=#file-system-scenario-1---contentspec>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// hugo-playground/deps/deps.go
</span></span></span><span style=display:flex><span><span style=color:#75715e>// line 145
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Process</span>(<span style=color:#e6db74>&#34;New content Spec&#34;</span>, <span style=color:#e6db74>&#34;content converter provider inside&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>contentSpec</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>helpers</span>.<span style=color:#a6e22e>NewContentSpec</span>(<span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Language</span>, <span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>BaseFs</span>.<span style=color:#a6e22e>Content</span>.<span style=color:#a6e22e>Fs</span>)
</span></span></code></pre></div><p>After the PathSpec is prepared, the creation of ContentSpec immediately uses Content.Fs,
which is SourceFilesystem.Fs, which depends on theBigFs.overlayMountsContent.</p><h3 id=file-system-scenario-2---loadtemplates>File system scenario 2 - loadTemplates
<a class=anchor href=#file-system-scenario-2---loadtemplates>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// hugo-playground/tpl/tplimpl/template.go
</span></span></span><span style=display:flex><span><span style=color:#75715e>// line 340
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>helpers</span>.<span style=color:#a6e22e>SymbolicWalk</span>(<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Layouts</span>.<span style=color:#a6e22e>Fs</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>walker</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>IsNotExist</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>Layouts.Fs</code> is used when loading user-defined templates.
Process the template files in the file system through walker, relying on <code>b.theBigFs.overlayDirs[files.ComponentFolderLayouts]</code></p><p>Combining the design and application of the above file system,
we can feel that the design requirements of the Hugo file system come from its own characteristics.
Because the concept of modules and the design of the module infrastructure are used.
The basic hugoFs cannot meet all the needs of Hugo in the process of operating the file system,
so further encapsulation is required.</p><p>Hugo&rsquo;s approach is to use PathSpec to organize all information, hide complexity,
and abstract BaseFs to provide comprehensive services that are closer to usage scenarios.
Use SourceFilesystems to organize intuitive services that conform to the characteristics of Hugo&rsquo;s infrastructure,
and use the underlying technology of OverlayFs to realize the requirements for merging multiple file systems,
and finally support the real actual usage scenarios.
Including the Content file system that provides article content services,
and the Layouts file system when loading custom templates, etc.</p><h2 id=site-content-collection-solutions>Site content collection solutions
<a class=anchor href=#site-content-collection-solutions>#</a></h2><p><a href=https://hugo.notes.sunwei.xyz/en/docs/how/arch/#organization-of-the-file-system>Organization of the file system</a>
has helped us organize user site projects according to the Hugo basic components The structure is organized.
We can directly obtain the file system index of the site content from <code>BaseFs.Content.Fs</code>,
and can directly read the file information to generate the site content.</p><p>But Hugo doesn&rsquo;t think so. We can use the following two scenarios to understand Hugo&rsquo;s lofty ambitions.</p><p><strong>Scene 1: Headless Bundle</strong></p><p>There is a page that we don&rsquo;t want her to publish as a separate page.
But you can get her in the form of a variable when you need her.
This is Hugo&rsquo;s solution to this need:
<a href=https://gohugo.io/content-management/page-bundles/#headless-bundle>Headless Bundle</a>.</p><p>If we directly traverse the file system, we need to know its type when processing the file.
If it is headless type, it will not be processed according to the conventional type.
The file type needs to be obtained from the file information when parsing the file.
The page type information can be placed in the file configuration, or can be indicated through special naming rules,
and there are many such schemes.</p><p>If other pages depend on the Headless page, the problems caused by the order of page parsing must be considered.
If Headless is parsed earlier, relevant index information must be stored to facilitate subsequent queries that depend on her files.
If it is parsed after other pages, a possible solution is to mark the previously processed page as incomplete,
specify the dependent Headless page, and suspend it to wait for the condition to be awakened.
After the parsing of the corresponding headless page is completed, when the time is right,
resume the parsing process of the previous page.
This solution will hang continuously when there are many dependent Headless pages.
In addition, these configurations all rely on manual maintenance,
and it is difficult to guarantee parsing efficiency and correctness.</p><p><strong>Scene 2: Page Resources</strong></p><p>Hugo Page can contain different resources, common ones are pictures, as well as audio, video, data,
compressed packages and other types of resources.</p><p>The download page will provide download links for resources, such as software installation packages,
and different versions will be provided for different operating systems.
Hugo can intelligently identify which files are page files and which pages are resource files,
and put the resource file information in the <code>Resources</code> property of the page.
In this way, it is convenient for users to organize these resources flexibly according to the page,
and can generate a download summary information of a certain type of software,
and can also generate download software information of a certain chapter.</p><p>If you traverse the file system directly, each file is relatively independent,
and you need to indicate the affiliation relationship of the same level through configuration information or other means,
and also indicate the reference relationship between different levels.
These all need to be stored in the global build info.
Because they are independent of each other, there will be a sequence in the traversal process.
The more complicated the relationship, the higher the probability of repeated information.
When new requirements emerge, complex logic processing is not conducive to software expansion.</p><p>From the above two scenarios, it can be observed.
Simply traversing the file system can indeed obtain basic file information.
However, if we need to flexibly organize various information, such as dependencies, resource summarization,
and other cross-page processing scenarios, we need to further explore the content of the site and organize and manage it in units of pages.</p><h3 id=sharpening-a-knife-does-not-delay-woodcutters>Sharpening a knife does not delay woodcutters
<a class=anchor href=#sharpening-a-knife-does-not-delay-woodcutters>#</a></h3><p>From
<a href=https://hugo.notes.sunwei.xyz/en/docs/how/event-storming/>Hugo Event Storm</a>,
it can be clearly seen that Hugo’s official collection of site content is in the <code>Hugo Build</code> stage,
and it was all in preparation before:</p><p><img src=images/5.1-hugo-ddd-content-collection.svg alt="Hugo DDD - Content Collection"></p><h3 id=clear-division-of-labor-and-efficient-collaboration>Clear division of labor and efficient collaboration
<a class=anchor href=#clear-division-of-labor-and-efficient-collaboration>#</a></h3><p>The current state of e-commerce is no longer integrating into our lives, but has become a part of our lives.
And after the period of competing product categories, basically what your family has, I also have.
Now the fight is more about features and services.
Since it is a feature, each one is more or less different.
The services are basically the same, the most important of which is the courier service.
Whoever can deliver packages to consumers in the shortest time will be most likely to be recognized by consumers,
thereby occupying a higher market share, gaining the favor of investors, and entering a virtuous circle of development.</p><p>Hugo also agrees with the service concept of delivery in the shortest time.
After getting the content to be processed,
it is immediately loaded out of the warehouse and sent to the sorting center closest to the consumer,
and then the goods are sorted by an efficient sorting robot.</p><p><strong>Hugo&rsquo;s goal for content processing</strong></p><p><img src=images/5.2-cpf-goal.svg alt="Content Process Flow Goal"></p><p>In our example, our Content is the file system represented by the <code>mycontent</code> directory.
After processing by <code>PathSpec</code>, the file system can be obtained through <code>site.BaseFs.Content.Fs</code>.
In the end, Hugo needs to classify all the content in the content file system and store it on the PageMap shelf,
so that the courier brother can quickly pick up the goods, load them into the car and deliver the package to the user.</p><p>How did Hugo do it?</p><p><strong>Land Container &ndash; Big Truck</strong></p><p><img src=images/5.3-cpf-pagescollector.svg alt="Content Process Flow PagesCollector"></p><p>In real life, packages will be transported by large trucks from all over the world through a network of sorting centers to the sorting point closest to consumers.
And Hugo&rsquo;s &ldquo;big truck&rdquo; is PagesCollector, which is not as complicated as the real world,
and the goods are all in <code>site.BaseFs.Content.Fs</code>.</p><p><strong>Sorting robot</strong></p><p><img src=images/5.4-cpf-pagesprocessor.svg alt="Content Process Flow PagesProcessor"></p><p>After the goods are transported to the sorting center, after continuous optimization of the sorting efficiency,
it can now be fully automated.
After PagesController delivers all the documents, the automatic sorting robot PagesProcessor starts to work seamlessly.
In order to improve processing efficiency, Hugo provides a robot for each site,
and PagesProcessor is responsible for distributing tasks,
and sitePagesProcessor focuses on the language categories it is good at.</p><p>Through a clear division of labor and efficient collaboration,
all documents are finally classified and neatly placed on the center shelf.</p><p><img src=images/5.0-content-process-flow.svg alt="Content Process Flow"></p><h2 id=template-lifecycle>Template Lifecycle
<a class=anchor href=#template-lifecycle>#</a></h2><p>In
<a href=https://hugo.notes.sunwei.xyz/en/docs/how/event-storming/>Hugo event storm</a>,
we learned about Hugo&rsquo;s design philosophy - to provide users with a consistent and easy writing expression.
The realization of this concept is to develop more practical functions based on the Golang Template,
so that content creators can focus on content creation while having a good experience.</p><p>Let&rsquo;s review the implementation steps of Golang Template:</p><p><img src=images/1-golang-template.svg alt="Golang Template"></p><p>Let&rsquo;s see how Hugo revolves around it:</p><p><img src=images/2.1-hugo-whole-process-map-go-template.svg alt="hugo whole process with golang template"></p><p>Hugo has done a lot of design around the Golang Template.
Now let&rsquo;s take a look at the life cycle of the template through the domain events related to the template,
to have a more comprehensive understanding.</p><h3 id=hugo-template-lifecycle-domain-events>Hugo Template Lifecycle Domain Events
<a class=anchor href=#hugo-template-lifecycle-domain-events>#</a></h3><p>Let’s start with domain events to see which key events are strongly related to templates:</p><p><img src=images/6.0-template-ddd-events.svg alt="Template DDD Events"></p><p>In addition to the above events that are mapped one by one with the Golang Template, there are more detailed events.
In order to be intuitive and beautiful, we collect these events together for analysis:</p><p><img src=images/6.0.1-template-ddd-events-simple.svg alt="Template DDD Events simple version"></p><p>You can see events that are strongly related to templates, mainly focusing on creating HugoSites and Build phases.
It can be found that the template life cycle can be divided into three stages:</p><ol><li>The initial phase includes registering a callback, selecting a template service provider, and starting the template update.<ul><li>Register layouts callback to HugoSites initialization field</li><li>Set the default template provider to the configuration item</li><li>Notify the template provider to start updating</li></ul></li><li>Preparation stage, including preparing the template executor, collecting template-related functions, parsing Hugo built-in and user-defined templates, storing all templates in the template namespace, and connecting layout and templates with the layout processor.<ul><li>New template executor</li><li>Collect template functions to function mappings</li><li>Collect text function-to-function mappings</li><li>New template namespace</li><li>New layout processor</li></ul></li><li>In the rendering stage, after the page content is prepared, call back the layouts items registered in the initial stage, find the corresponding template through the layout processor, and finally render with the template to generate the site page<ul><li>Create pages for content nodes</li><li>Call back the layout registration item to initialize</li><li>Find templates for pages</li><li>Render the page with a template</li></ul></li></ol><p>Events can help us clearly understand the template life cycle designed by Hugo.
Next, let&rsquo;s sort out the specific implementation process through the source code of
<a href=https://hugo.notes.sunwei.xyz/en/docs/how/playground/>Hugo playground</a>,
so that we can understand the template life cycle in a more three-dimensional way,
and at the same time prepare for the following code implementation explanation chapters.</p><p><strong>Template vs Layouts</strong></p><p>Let&rsquo;s first look at two confusing concepts in Hugo, Template and Layouts.</p><p>When creating a
<a href=https://hugo.notes.sunwei.xyz/en/docs/what/theme/>custom Hugo theme</a>, the most we touch is Layouts.
The official document explains that Layouts are used as templates.
There is no problem with this explanation, but it will make it easy for us to have the illusion that Layouts are both templates,
and directly equate Layouts and templates.</p><p>But is this really the case, let us look at their association from the code level:</p><p><img src=images/6.2-layouts-vs-template.svg alt="Template vs Layouts"></p><p>By looking at the directory structure of the newly created theme,
we will find that the automatically generated files are mainly in the layouts directory,
including the home page template, header and footer templates, and so on.
In the code, Layouts appear in the form of <code>[]string</code>string array.
That is to say, in <strong>code, Layouts is used to record layout-related file path information</strong>.</p><p>If you want to convert Layouts into Golang Template, you need to convert it into <code>templateInfo</code> first.
And record the file name, analyze whether it is a text type,
and store the content of the layout file in the template field as a string.</p><p>Whether it is a text type involves the design knowledge of Golang Template.</p><blockquote><p>Golang divides Template by type. Such as HTML and Text, by converting HTML tags, they will eventually be converted into Text.
In the final analysis, through the conversion of different template types, they will all become text types.</p></blockquote><p>Through templateInfo, Hugo will eventually generate the real Hugo template structure <code>templateState</code>.
It can be seen that the structure implements the <code>Template</code> interface.</p><p>So we can draw a conclusion: Layouts is not equal to Template, it is the raw material for making Template.</p><p>After clarifying the relationship between Template and Layouts, let&rsquo;s take a look at the start,
preparation and rendering phases of the Template life cycle.</p><p><strong>Initial stage</strong></p><p><img src=images/6.1.1-template-cycle-start.svg alt="Template Cycle Start"></p><p>The init field in <code>HugoSites</code> is of type <code>hugoSitesInit</code>, which contains layouts of type lazy.init.
In this way, some callback methods can be registered in the layouts field,
which is convenient for callback when the time is right.</p><p>At the same time, for HugoSites, it is directly facing the provider of the template service,
so <code>TemplateProvider</code> needs to be set as the provider in the configuration information at this stage.
After the information is ready, the template service provider can be notified to start the work update.</p><p><strong>Preparation Phase</strong></p><p><img src=images/6.1.2-template-cycle-prepare.svg alt="Template Cycle Prepare"></p><p>It provides overall services externally and is associated with Deps is <code>templateExec</code>.
Contains <code>texttemplate.executer</code> and <code>templateHandler</code>, and all template functions.
Colors indicate the associations between structures.</p><p>It can be seen that <code>texttemplate.executer</code> contains <code>templateExecHelper</code>, because during the execution process,
through the analysis of the template, the function may be used.</p><p>And <code>templateHander</code> needs to handle some operations related to template.
The <code>main</code> field is of type <code>templateNamespace</code>, which stores HTML and Text prototype information,
and stores all <code>templateState</code> created by the prototype in <code>templateStateMap</code>.
<code>layoutHandler</code> is the key to connect layout and template. For example, when querying template through layout,
layoutHandler is fully responsible.</p><p><strong>rendering phase</strong></p><p>Combining the overview of the init phase and the preparation phase:</p><p><img src=images/6.1.3-template-cycle-start-and-prepare.svg alt="Template Cycle Start and Prepare"></p><p>With pre-preparation and organization, let&rsquo;s take a look at how the rendering phase happens:</p><p><img src=images/6.3-template-cycle-execute.svg alt="Template Cycle Render"></p><p>Page rendering happens in <code>site_render.go</code>, officially started with <code>pageRender</code>.</p><p>It is divided into two steps in total.
One is <code>page.resolveTemplate</code> to parse the template,
and then start <code>site.renderAndWritePage</code> to render and write the page after getting the template.</p><ol><li><p>Parse the template
Because Site combines Deps, it also holds <code>templateExec</code> information like Deps,
and queries template information by calling <code>LookupLayout</code> method of <code>templateExec</code>.
Because these template information have been stored in <code>templateStateMap</code> in <code>templateNamespace</code>.</p></li><li><p>Render the page
We already have the page information <code>pageState</code> in <code>pageRender</code>,
and the template information has been obtained through the previous step,
so it is time to start the actual <code>site.renderForTemplate</code> rendering.
Or call the <code>Execute</code> method through <code>templateExec</code>.
Because the current executor is of <code>texttemplate.executer</code> type,
the actual execution is in the <code>ExecuteWithContext</code> method of <code>texttemplate.executer</code>.
Here is the Golang Template source code used directly, instead of calling the default package of Golang.
Because the functions that come with Golang’s default package cannot fully meet Hugo’s demands.
It will be described in detail in the subsequent code implementation chapters,
and here we still focus on the initial understanding of the infrastructure.</p></li></ol><h3 id=summary>summary
<a class=anchor href=#summary>#</a></h3><p><img src=images/6.1-template-cycle.svg alt="Template Cycle"></p><p>Starting from the Golang Template application example, we learned the basic process of template work in Golang.
This helps us further understand the design and implementation of Hugo.</p><p>By analyzing the core events that are strongly related to templates in Hugo domain events,
we roughly divide the life cycle of Hugo templates into three stages: init, preparation, and rendering.</p><p>In order to understand the template life cycle three-dimensionally, we not only sort out the domain events,
but also analyze the code structure.
Seeing that Hugo is based on HTML and Text template prototypes,
it helps convert all Layouts into Templates and stores them in the Template namespace.
We also saw that in order to extend the functionality of the Golang Template,
Hugo saves powerful custom functions in the executor.
This allows the template to have more helpers during the rendering process.
And all of these are encapsulated in the service <code>templateExec</code> provided externally,
which not only encapsulates internally, but also provides convenience externally.</p><p>There are more interesting things, such as why can&rsquo;t Hugo directly use Golang&rsquo;s built-in Template package,
but maintain it independently?
We will also further expand the explanation in the subsequent code implementation chapter.
Together with everyone, find out.</p><h2 id=publish-process>Publish process
<a class=anchor href=#publish-process>#</a></h2><p>Through
<a href=https://hugo.notes.sunwei.xyz/en/docs/how/arch/#template-lifecycle>template life cycle</a>,
we can see that in the final rendering stage, the Template of the page is first found, and then the page is rendered.
In this way, we have the content to be published based on the template.</p><p>The main task of site publishing is to convert the content created by the author into the content to be published through template conversion,
and write it into the file directory we specify according to the output format of the site.</p><p>Then there will be two problems here:</p><ol><li>How is the content created by the author stored on the page and how to use it?</li><li>Who provided the information during the publishing process, such as output format, file name, and writing address?</li></ol><p>We still start from the basic principles of Golang Template:</p><p><img src=images/1-golang-template.svg alt="Golang Template"></p><p>In the index.html template, we plan to use the <code>{{.Content}}</code> attribute to get the content.
To get it successfully, we need to set the correct value in the Content field in our content provider <code>Post</code> instance.
If everything is prepared according to the agreement,
we can find the content in the upper right corner in the final Golang Template execution result.</p><p>In our
<a href=https://hugo.notes.sunwei.xyz/en/docs/how/playground/>playground example</a>,
we also have a layout that uses <code>.Content</code> - <code>layouts/_default/single.html</code>:</p><pre tabindex=0><code>-- mycontent/blog/post.md --
---
title: &#34;Post Title&#34;
---
### first blog
Hello Blog

-- layouts/_default/single.html --
{{ .Content }}
===
Static Content
===
</code></pre><p>single.html will be used as a template for individual pages, such as <code>mycontent/blog/post.md</code> above.
After rendering through the template, the content in <code>post.md</code> will replace <code>{{ .Content }}</code> in <code>single.html</code>.</p><p>How does Hugo&rsquo;s page object PageState provide content services?
Is it the same as above, is it placed in the attribute?
We quickly found the answer in the source code of
<a href=https://github.com/sunwei/hugo-playground>Hugo Playground</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Page is the core interface in Hugo.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Page</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ContentProvider</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ContentProvider provides the content related values for a Page.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ContentProvider</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Content</span>() (<span style=color:#a6e22e>any</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That&rsquo;s right, it&rsquo;s ContentProvider.
It can be seen that Golang Template not only supports attributes, but also supports methods.
The common feature is to be visible to the outside world - all start with a capital letter.</p><p>Then the above two questions become more specific:</p><ol><li>Who is the ContentProvider in PageState?</li><li>Where do the details needed in the release process come from?</li></ol><p><strong>Publish related domain events</strong></p><p>Similarly, we can start by publishing related domain events in
<a href=https://hugo.notes.sunwei.xyz/en/docs/how/event-storming/>Domain Event Storm</a>:</p><p><img src=images/7.0-publish-events.svg alt="Publish Events"></p><p>It can be seen that there are two key moments.
One is during the site creation period, and the other is during the construction period.</p><p>Let&rsquo;s focus on publishing related events:</p><p><img src=images/7.0.1-publish-events-simple.svg alt="Publish Events Simple"></p><p>The interpretation of these events is described in detail in
<a href=https://hugo.notes.sunwei.xyz/en/docs/how/event-storming/>Domain Event Storm</a>,
so I won’t go into details here.</p><p>Combined with
<a href=https://github.com/sunwei/hugo-playground>source code</a>,
we further convert the above events into a code flow chart:</p><p><img src=images/7.1-publish-work-flow.svg alt="Publish Work Flow"></p><p>As expected, the object that provides content and other information services for PageState does exist,
and that is <code>pageOutputs</code>.
But a doubt arises in my heart, why is it plural?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// We create a pageOutput for every output format combination, even if this
</span></span></span><span style=display:flex><span><span style=color:#75715e>// particular page isn&#39;t configured to be rendered to that format.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pageOutput</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// These interface provides the functionality that is specific for this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// output format.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pagePerOutputProviders</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>ContentProvider</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// these will be shifted out when rendering a given output format.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pagePerOutputProviders</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>targetPather</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>By consulting the above source code definition, we are more sure of the correctness of our analysis.
<code>PageOutput</code> does provide <code>ContentProvider</code> service and <code>targetPather</code> service as we expected,
so that our previous two problems will be resolved.</p><p>Plus the annotation:</p><blockquote><p>We create a pageOutput for every output format combination, even if this
particular page isn&rsquo;t configured to be rendered to that format.</p></blockquote><p>We found that pageOutput corresponds to output format one by one, that is to say,
there are as many pageOutputs as there are output formats, which also explains the above question about complex numbers.</p><p>What kind of corresponding relationship is it, and why is it designed in this way?
Let us still combine the above flow chart for analysis.</p><p><strong>Preparation work done when the site is created</strong></p><p><img src=images/7.2-publish-start.svg alt="Publish Site Creating"></p><p>Let&rsquo;s first look at what release-related information is prepared when creating a Site.
The right side of the above figure is the part of the flow chart site.
From the perspective of object reference relationship, we can understand that OutputFormats depends on OutputFormat,
but not the aggregation relationship.
And OutputFormat depends on MediaType.</p><p><strong>MediaType</strong></p><p>As can be seen from the structure diagram on the left side of the above figure, OutputFormat has a MediaType field.
The main fields contained in MediaType are main and sub.</p><p>What are these fields for?
We can take a closer look at the middle part of the picture above.
In Hugo&rsquo;s DefaultTypes, after simplification, we retain four types: HTML, MD, TOML, and TEXT.
Take HTML MediaType as an example, it actually looks like <code>text/html</code>.
That&rsquo;s right, the main field is text, and the sub field is html.
Because first the files of the HTML media type are stored on disk as text, and then the content is organized in HTML format.
For a detailed introduction of Media Type, please refer to
<a href=https://en.wikipedia.org/wiki/Media_type>Wikipedia</a>.</p><p><strong>OutputFormat</strong></p><p>Let&rsquo;s look at OutputFormat again:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Format represents an output representation, usually to a file on disk.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Format</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>   <span style=color:#75715e>// The Name is used as an identifier. Internal output formats (i.e. HTML and RSS)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#75715e>// can be overridden by providing a new definition for those types.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#a6e22e>Name</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>MediaType</span> <span style=color:#a6e22e>media</span>.<span style=color:#a6e22e>Type</span> <span style=color:#e6db74>`json:&#34;-&#34;`</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   <span style=color:#75715e>// The base output file name used when not using &#34;ugly URLs&#34;, defaults to &#34;index&#34;.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#a6e22e>BaseName</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;baseName&#34;`</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As you can see from the annotation,
the actual function is to record the relevant description information to output a file to the disk.
For example, the default value of BaseName is index, which will be used on the home page,
and the default file name is index.html.</p><p>The <code>DefaultFormats</code> provided by Hugo has been simplified according to our example and retains three types: HTML, JSON, and MD.
Where HTML means that we will write the file to disk in HTML output format.</p><p>Examples are as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>HTMLFormat</span> = <span style=color:#a6e22e>Format</span>{
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>Name</span>:          <span style=color:#e6db74>&#34;HTML&#34;</span>,
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>MediaType</span>:     <span style=color:#a6e22e>media</span>.<span style=color:#a6e22e>HTMLType</span>,
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>BaseName</span>:      <span style=color:#e6db74>&#34;index&#34;</span>,
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>Rel</span>:           <span style=color:#e6db74>&#34;canonical&#34;</span>,
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>IsHTML</span>:        <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>Permalinkable</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#75715e>// Weight will be used as first sort criteria. HTML will, by default,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     <span style=color:#75715e>// be rendered first, but set it to 10 so it&#39;s easy to put one above it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     <span style=color:#a6e22e>Weight</span>: <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span> }
</span></span></code></pre></div><p><strong>OutputFormats</strong></p><p>If OutputFormats and OutputFormat are not an aggregation relationship, then what is the relationship?</p><p>Let&rsquo;s take a look at the structure of OutputFormats directly, and the answer will be clear.</p><p><img src=images/7.2.1-publish-start-output-formats.svg alt="Publish Start Output Formats"></p><p>The OutputFormats here are actually the OutputFormat mappings provided by the five types of Hugo pages.
If it is a home type page, then this type of page only provides results rendered in HTML format, not other formats,
such as JSON.
That is to say <strong>Under a site, the legal output format will be clearly defined for each type of page</strong>.
This will effectively guarantee the validity of the output format during the page rendering process.</p><p><strong>renderFormats</strong></p><p>With a comprehensive site page output specification, why do we need this renderFormats?</p><p><img src=images/7.3-publish-output.svg alt="Publish Output"></p><p>As you can see from the lower right corner of the figure above, renderFormats actually comes from outputFormats.
It is generated by merging the outputFormats of all pages and deduplicating them.
It can be understood that renderFormats represents all output types of this site.
In our example, because all pages only support one type of HTML, after merging and deduplication,
naturally our site has only one renderFormats, which is HTML.</p><p>From the perspective of value, we already know the relationship between the two, so why does Hugo set a renderFormats?
From the name, it takes the site as the unit, which can be understood as all the rendering formats of the site when rendering.</p><p>So why does HugoSites have the same renderFormats?
As can be seen from the upper left of the above figure, the renderFormats of the Site form the renderFormats of HugoSites.
This is easy to understand, because HugoSites is composed of multiple sites in different languages, that is to say,
the renderFormats of HugoSites represent the rendering format of the entire site.</p><p>Continue to look to the right through the picture above to find more clues.
It turns out that there is a one-to-one correspondence between pageOutputs and renderFormats of HugoSites,
that is to say, there are as many pageOutputs as there are rendering formats in the whole site.</p><p>Here comes another big question mark - each site has its own page and its own output format,
**why provide pageOutputs in the site-wide output format for a single site page? **</p><p>Similarly, we can still find the answer from the source code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// hugo-playground/hugolib/page__new.go
</span></span></span><span style=display:flex><span><span style=color:#75715e>// line 97
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Prepare output formats for all sites.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// We do this even if this page does not get rendered on
</span></span></span><span style=display:flex><span><span style=color:#75715e>// its own. It may be referenced via .Site.GetPage and
</span></span></span><span style=display:flex><span><span style=color:#75715e>// it will then need an output format.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>pageOutputs</span> = make([]<span style=color:#f92672>*</span><span style=color:#a6e22e>pageOutput</span>, len(<span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>renderFormats</span>))
</span></span></code></pre></div><p>As can be seen from the above code, the reason for this design is that the page may be referenced by other pages,
or even called by pages in different languages.</p><p>The
<a href=https://gohugo.io/functions/getpage/#getpage-and-multilingual-sites>specific description</a> of the corresponding
<code>.Site.GetPage</code> function in a multilingual usage scenario is as follows:</p><blockquote><p>The previous examples have used the full content filename to lookup the post.
Depending on how you have organized your content (whether you have the language
code in the file name or not, e.g. my-post.en.md), you may want to do the lookup
without extension. This will get you the current language’s version of the page:</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>{{ <span style=color:#a6e22e>with</span> .<span style=color:#a6e22e>Site</span>.<span style=color:#a6e22e>GetPage</span> <span style=color:#e6db74>&#34;/blog/my-post&#34;</span> }}{{ .<span style=color:#a6e22e>Title</span> }}{{ <span style=color:#a6e22e>end</span> }}
</span></span></code></pre></div><p>Since there is a cross-site call, the output format required by the caller must be prepared for the caller.
Looking back, it is necessary to prepare pageOutputs in the full site rendering format for each page pageState.</p><p><strong>pageOutputs</strong></p><p>In the publishing process, in addition to the content, some basic information is also reused,
such as where to publish, under what name, and so on.
pageOutput is the general carrier of the output information, and this information is naturally included in it.
From the upper right of the figure above, you can see that the object responsible for providing this information is PagePaths.
Which provides the target file name is the targetPaths.</p><p><strong>PagePaths</strong></p><p>Careful friends will find that there is a dotted line connection between OutputFormats and PagePaths of the Site.
The reason for the dotted line is that PagePaths is actually the information obtained from pageMeta,
but the source is actually from the OutputFormats of the Site.</p><p>There are further example explanations in the middle and bottom.
You can see that PagePaths will obtain the current type of OutputFormats according to the type <code>pageKind</code> of the current page pageState.
The corresponding targetPathsHolder will be generated according to each OutputFormat.</p><p>According to the OutputFormat type of each PageOutput,
select the corresponding targetPathsHolder and set it in <code>pagePerOutputProviders</code>.
So when rendering the page:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>pageRenderer</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>siteRenderContext</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Site</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pages</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pageState</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>results</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>error</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>wg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>pages</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>templ</span>, <span style=color:#a6e22e>found</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>resolveTemplate</span>()
</span></span><span style=display:flex><span>		<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>targetPath</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>targetPaths</span>().<span style=color:#a6e22e>TargetFilename</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>renderAndWritePage</span>(<span style=color:#e6db74>&#34;page &#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>Title</span>(), <span style=color:#a6e22e>targetPath</span>, <span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>templ</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34; render err&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%#v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>results</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You can get the target file name through <code>p.targetPaths().TargetFilename</code>.</p><h3 id=publishing-process-for-independent-pages>Publishing process for independent pages
<a class=anchor href=#publishing-process-for-independent-pages>#</a></h3><p>Hugo divides the pages into two categories, one is the regular pages described above,
and the other is the independent Standalone pages to be seen next, such as 404 pages.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Site</span>) <span style=color:#a6e22e>render404</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newPageStandalone</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pageMeta</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>:    <span style=color:#a6e22e>s</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>kind</span>: <span style=color:#a6e22e>kind404</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>urlPaths</span>: <span style=color:#a6e22e>pagemeta</span>.<span style=color:#a6e22e>URLPath</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>URL</span>: <span style=color:#e6db74>&#34;404.html&#34;</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>HTMLFormat</span>,
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>render</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>d</span> <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>LayoutDescriptor</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Kind</span> = <span style=color:#a6e22e>kind404</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>templ</span>, <span style=color:#a6e22e>found</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Tmpl</span>().<span style=color:#a6e22e>LookupLayout</span>(<span style=color:#a6e22e>d</span>, <span style=color:#a6e22e>output</span>.<span style=color:#a6e22e>HTMLFormat</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>found</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>targetPath</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>targetPaths</span>().<span style=color:#a6e22e>TargetFilename</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>targetPath</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;failed to create targetPath for 404 page&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>renderAndWritePage</span>(<span style=color:#e6db74>&#34;404 page&#34;</span>, <span style=color:#a6e22e>targetPath</span>, <span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>templ</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The code flow is very clear. First create a page through <code>newPageStandalone</code>, then find the template,
get the target file name, and finally render and write the page.
The overall process is basically the same.</p><p>Since PageOutput is the relationship in the publishing process,
let&rsquo;s use the perspective of PageOutput to see how the independent pages will be different,
and at the same time, we can also check whether our previous understanding is correct.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// hugo-playground/hugolib/page__new.go
</span></span></span><span style=display:flex><span><span style=color:#75715e>// line 92
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newPageFromMeta</span>(
</span></span><span style=display:flex><span><span style=color:#a6e22e>n</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>contentNode</span>,
</span></span><span style=display:flex><span><span style=color:#a6e22e>parentBucket</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pagesMapBucket</span>,
</span></span><span style=display:flex><span><span style=color:#a6e22e>meta</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>,
</span></span><span style=display:flex><span><span style=color:#a6e22e>metaProvider</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pageMeta</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>pageState</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>standalone</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>pageOutput</span> = <span style=color:#a6e22e>makeOut</span>(<span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>outputFormats</span>()[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>shouldRenderPage</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>outputFormatsForPage</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>outputFormats</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Through the <code>newPageFromMeta</code> source code, we found that the <code>standalone</code> page is specially processed,
and the <code>output.HTMLFormat</code> passed in <code>render404</code> is used to generate the pageOutput.</p><p>In this way, we can say with certainty that whether it is a normal page or an independent page,
it is basically developed with pageOutput as the core, which conforms to the same publishing process.
Let&rsquo;s review the release process panorama again:</p><p><img src=images/7.4-publish-full.svg alt="Publish Process Full Process"></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/sunwei/hugo-notes/commit/1bd46c1ec795c2fe1775ec44af675a588e94b48e title='Last modified by sunwei | February 9, 2023' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>February 9, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/sunwei/hugo-notes/edit/main/content/docs/how/arch/index.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#hugo-architecture>Hugo Architecture</a><ul><li><a href=#architecture-design-of-hugo>Architecture Design of Hugo</a><ul><li><a href=#configuration-module>Configuration Module</a></li><li><a href=#hugosites-module>HugoSites Module</a></li><li><a href=#deps-module>Deps Module</a></li></ul></li><li><a href=#hugos-component-design>Hugo&rsquo;s component design</a><ul><li><a href=#the-relationship-between-configuration-and-language>The relationship between configuration and language</a></li><li><a href=#configprovider>config.Provider</a></li><li><a href=#depscfg>DepsCfg</a></li><li><a href=#hugo-modules>Hugo modules</a></li></ul></li><li><a href=#organization-of-the-file-system>Organization of the file system</a><ul><li><a href=#afero>Afero</a></li><li><a href=#fs-in-hugo-architecture>Fs in Hugo architecture</a></li><li><a href=#hugofs>HugoFs</a></li><li><a href=#pathspec>PathSpec</a></li><li><a href=#basefs>BaseFs</a></li><li><a href=#sourcefilesystems>SourceFilesystems</a></li><li><a href=#thebigfs>theBigFs</a></li><li><a href=#file-system-scenario-1---contentspec>File system scenario 1 - ContentSpec</a></li><li><a href=#file-system-scenario-2---loadtemplates>File system scenario 2 - loadTemplates</a></li></ul></li><li><a href=#site-content-collection-solutions>Site content collection solutions</a><ul><li><a href=#sharpening-a-knife-does-not-delay-woodcutters>Sharpening a knife does not delay woodcutters</a></li><li><a href=#clear-division-of-labor-and-efficient-collaboration>Clear division of labor and efficient collaboration</a></li></ul></li><li><a href=#template-lifecycle>Template Lifecycle</a><ul><li><a href=#hugo-template-lifecycle-domain-events>Hugo Template Lifecycle Domain Events</a></li><li><a href=#summary>summary</a></li></ul></li><li><a href=#publish-process>Publish process</a><ul><li><a href=#publishing-process-for-independent-pages>Publishing process for independent pages</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>