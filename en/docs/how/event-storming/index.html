<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Hugo 事件风暴 # Hugo的功能很全面，拥有强大的自定义函数库，可以用来制作模板、短代码等。 这在站点的构建过程中，可以帮助提供各种数据，如获取目录结构，主动加载文件。 以及页面信息汇总，方便展示分页列表或者搜索。 还可以帮助分类，提供标签服务。
支持多语言，创建国际化站点一样简单。
主题库更是能满足各种不同的个性化需求，更贴近专业使用场景，你还可以零成本切换。
Hugo是如何一步步将博客变成站点的？ 下面我们还是通过 游乐场实例，来一探究竟。
邀你一起来动手。 用我们最喜欢的IDE，打开我们的 游乐场项目源码。 通过直接输出日志的方式，来看一看hugo的完整构建流程。
$ cd /go/to/hugo-playground $ go run . 先来看一看主流程。 通过搜索以字符串&#34;==> Process main:&ldquo;开头的日志条目，我们可以了清楚的看到主函数的处理流程如下所示：
==> Process main: prepare example project file systems ==> Process main: load configurations from config.toml and themes ==> Process main: setup hugo file systems based on machine file system and configurations ==> Process main: create hugo sites based on deps ==> Process main: hugo building."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content><meta property="og:description" content="Hugo 事件风暴 # Hugo的功能很全面，拥有强大的自定义函数库，可以用来制作模板、短代码等。 这在站点的构建过程中，可以帮助提供各种数据，如获取目录结构，主动加载文件。 以及页面信息汇总，方便展示分页列表或者搜索。 还可以帮助分类，提供标签服务。
支持多语言，创建国际化站点一样简单。
主题库更是能满足各种不同的个性化需求，更贴近专业使用场景，你还可以零成本切换。
Hugo是如何一步步将博客变成站点的？ 下面我们还是通过 游乐场实例，来一探究竟。
邀你一起来动手。 用我们最喜欢的IDE，打开我们的 游乐场项目源码。 通过直接输出日志的方式，来看一看hugo的完整构建流程。
$ cd /go/to/hugo-playground $ go run . 先来看一看主流程。 通过搜索以字符串&#34;==> Process main:&ldquo;开头的日志条目，我们可以了清楚的看到主函数的处理流程如下所示：
==> Process main: prepare example project file systems ==> Process main: load configurations from config.toml and themes ==> Process main: setup hugo file systems based on machine file system and configurations ==> Process main: create hugo sites based on deps ==> Process main: hugo building."><meta property="og:type" content="article"><meta property="og:url" content="https://hugo.notes.sunwei.xyz/en/docs/how/event-storming/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-02-07T19:41:29+08:00"><title>Index | Deep Understanding of Hugo</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css integrity="sha256-xYKS02sYtnVoCrm66iApIEU3uDnqcvJYdG7A8yzo1sg=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.41743d83030238b334e913fdcec928d15ad230d34aca803186bd43630aca0237.js integrity="sha256-QXQ9gwMCOLM06RP9zsko0VrSMNNKyoAxhr1DYwrKAjc=" crossorigin=anonymous></script>
<script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/en/><span>Deep Understanding of Hugo</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul class=book-languages><li><input type=checkbox id=languages class=toggle>
<label for=languages class="flex justify-between"><a role=button class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
English</a></label><ul><li><a href=https://hugo.notes.sunwei.xyz/>Chinese</a></li></ul></li></ul><ul><li><p><strong>Hugo usage examples</strong></p></li><li><p><a href=/en/docs/what/site/>Create Site</a></p></li><li><p><a href=/en/docs/what/theme/>Custom Theme</a><br></p></li><li><p><strong>Hugo Architecture</strong></p></li><li><p><a href=/en/docs/how/playground/>Playground</a></p></li><li><p><a href=/en/docs/how/event-storming/ class=active>Event Storming</a></p></li><li><p><a href=/en/docs/how/arch/>Architecture</a><br></p></li><li><p><a href=/en/docs/code/><strong>Source Code</strong></a></p></li><li><p><a href=/en/docs/code/config/>Configuration</a></p></li><li><p><a href=/en/docs/code/deps/>Deps Management</a></p><ul><li><a href=/en/docs/code/deps/pathspec/>PathSpec</a></li><li><a href=/en/docs/code/deps/contentspec/>ContentSpec</a></li></ul></li><li><p><a href=/en/docs/code/site/>Site Creating</a></p><ul><li><a href=/en/docs/code/site/create/>Create Site</a></li><li><a href=/en/docs/code/site/resources/>Load Resources</a></li><li><a href=/en/docs/code/site/markdown/>Markdown</a></li></ul></li><li><p><a href=/en/docs/code/build/>Site Building</a></p><ul><li><a href=/en/docs/code/build/template/>Template Exec</a><br></li></ul></li></ul><ul><li><a href=/en/posts/>Blog</a></li><li><a href=https://github.com/sunwei/hugo-book target=_blank rel=noopener>Github</a></li><li><a href=https://themes.gohugo.io/hugo-book/ target=_blank rel=noopener>Hugo Themes</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Index</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#hugo-事件风暴>Hugo 事件风暴</a><ul><li><a href=#golang-template>GoLang Template</a><ul><li><a href=#show-me-the-code>Show Me The Code</a></li></ul></li><li><a href=#看hugo对站点构建的理解和设计>看Hugo对站点构建的理解和设计</a><ul><li><a href=#ddd之事件风暴>DDD之事件风暴</a></li><li><a href=#hugo构建之主流程---事件风暴版>Hugo构建之主流程 - 事件风暴版</a></li><li><a href=#hugo构建之loadconfig>Hugo构建之LoadConfig</a></li><li><a href=#hugo构建之hugofs>Hugo构建之HugoFs</a></li><li><a href=#hugo构建之sites>Hugo构建之Sites</a></li><li><a href=#hugo构建之loadconfig-1>Hugo构建之LoadConfig</a></li></ul></li><li><a href=#小结>小结</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=hugo-事件风暴>Hugo 事件风暴
<a class=anchor href=#hugo-%e4%ba%8b%e4%bb%b6%e9%a3%8e%e6%9a%b4>#</a></h1><p>Hugo的功能很全面，拥有强大的自定义函数库，可以用来制作模板、短代码等。
这在站点的构建过程中，可以帮助提供各种数据，如获取目录结构，主动加载文件。
以及页面信息汇总，方便展示分页列表或者搜索。
还可以帮助分类，提供标签服务。</p><p>支持多语言，创建国际化站点一样简单。</p><p>主题库更是能满足各种不同的个性化需求，更贴近专业使用场景，你还可以零成本切换。</p><p>Hugo是如何一步步将博客变成站点的？
下面我们还是通过
<a href=%e6%b8%b8%e4%b9%90%e5%9c%ba.md>游乐场</a>实例，来一探究竟。</p><img src=./images/goal.svg alt=goal height=400><p>邀你一起来动手。
用我们最喜欢的IDE，打开我们的
<a href=https://github.com/sunwei/hugo-playground>游乐场</a>项目源码。
通过直接输出日志的方式，来看一看hugo的完整构建流程。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cd /go/to/hugo-playground
</span></span><span style=display:flex><span>$ go run .
</span></span></code></pre></div><p><img src=terminalizer/process.gif alt="process log gif"></p><p>先来看一看主流程。
通过搜索以字符串"==> Process main:&ldquo;开头的日志条目，我们可以了清楚的看到主函数的处理流程如下所示：</p><pre tabindex=0><code>==&gt; Process main: prepare example project file systems
==&gt; Process main: load configurations from config.toml and themes
==&gt; Process main: setup hugo file systems based on machine file system and configurations
==&gt; Process main: create hugo sites based on deps
==&gt; Process main: hugo building...
</code></pre><ul><li>准备样例文件系统。100%模拟真实项目，写入硬盘</li><li>加载项目配置文件 - config.toml，并解析配置信息，如读取配置主题<code>theme = mytheme</code>信息</li><li>准备好hugo file systems。因为hugo项目的默认结构有包含多个目录，hugo会根据不同目录生成多个文件系统。（tips: 可以用<code>$ hugo new site &lt;name></code>
命令查看默认项目目录结构）</li><li>创建hugo sites。hugo支持多语言，会为每个语言创建一个site。创建前需要准备好所有的依赖，如上面提到的文件系统就是依赖之一。</li><li>开始构建，并发布站点资源</li></ul><img src=./images/0-main-process.svg alt="main process" height=100><h2 id=golang-template>GoLang Template
<a class=anchor href=#golang-template>#</a></h2><p>从主流程可以看出，Hugo的渲染思路并不复杂，就是用模板(Layouts)，将不同的内容(Content)渲染成网站静态资源(Site)。</p><p>而实现这一设计的核心技术就是<strong>GoLang Template</strong>。</p><img src=./images/1-golang-template.svg alt=template height=400><ol><li>通过Markdown解析器将post.md解析成结构体Post</li><li>通过GoLang Template包根据index.html创建模板实例</li><li>执行并生成渲染后的最终结果</li></ol><h3 id=show-me-the-code>Show Me The Code
<a class=anchor href=#show-me-the-code>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;html/template&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// index html template
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>indexTemplate</span> = <span style=color:#e6db74>&#34;&lt;html&gt;\n  &lt;body&gt;\n    {{.Content}}\n  &lt;/body&gt;\n&lt;/html&gt;\n&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Post struct with exposed filed Content
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Post</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Content</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// New Post with content
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Source file could be post.md
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>post</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Post</span>{<span style=color:#e6db74>&#34;&lt;h2&gt;Section&lt;/h2&gt;\n    &lt;p&gt;Hello World&lt;/p&gt;\n&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// New template with indexTemplate, name as &#34;index&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>tmpl</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>template</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;index&#34;</span>).<span style=color:#a6e22e>Parse</span>(<span style=color:#a6e22e>indexTemplate</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Render post with template `index`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// write result to os.Stdout
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>tmpl</span>.<span style=color:#a6e22e>Execute</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdout</span>, <span style=color:#a6e22e>post</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Output Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span># body content with tag h2: Section
</span></span><span style=display:flex><span># tag p: Hello World
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>html</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>&amp;lt;h2&amp;gt;Section&amp;lt;/h2&amp;gt;
</span></span><span style=display:flex><span>&amp;lt;p&amp;gt;Hello World&amp;lt;/p&amp;gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>html</span>&gt;
</span></span></code></pre></div><p><a href=https://c.sunwei.xyz/template.html>Try it yourself</a></p><p>了解了站点渲染的基本原理后，我们再从全局视角来看看Hugo完整的构建流程。</p><h2 id=看hugo对站点构建的理解和设计>看Hugo对站点构建的理解和设计
<a class=anchor href=#%e7%9c%8bhugo%e5%af%b9%e7%ab%99%e7%82%b9%e6%9e%84%e5%bb%ba%e7%9a%84%e7%90%86%e8%a7%a3%e5%92%8c%e8%ae%be%e8%ae%a1>#</a></h2><p>在
<a href=https://github.com/sunwei/hugo-playground>游乐场</a>项目源码下， 运行以下命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ cd /go/to/hugo-playground
</span></span><span style=display:flex><span>$ go run .
</span></span></code></pre></div><p>就可以得到构建全流程日志，如下所示</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>➜  hugo-playground git:(main) go run .
</span></span><span style=display:flex><span>==&gt; Process main: prepare example project file systems
</span></span><span style=display:flex><span>==&gt; Process main: load configurations from config.toml and themes
</span></span><span style=display:flex><span>==&gt; Process LoadConfig: start init configLoader
</span></span><span style=display:flex><span>==&gt; Process loadConfig: load config.toml from hard disk
</span></span><span style=display:flex><span>==&gt; Process loadConfig: set loaded config map to configLoader.cfg with key &#39;&#39;
</span></span><span style=display:flex><span>==&gt; Process LoadConfig: apply config defaults
</span></span><span style=display:flex><span>==&gt; Process LoadConfig: load modules config
</span></span><span style=display:flex><span>==&gt; Process decodeConfig: set mytheme as Imports in DefaultModuleConfig, Config{}
</span></span><span style=display:flex><span>==&gt; Process LoadConfig: collect modules with modulesConfig
</span></span><span style=display:flex><span>==&gt; Process collectHook: apply default mounts to project module
</span></span><span style=display:flex><span>==&gt; Process collectModules: set active modules to config with key &#39;allModules&#39;
</span></span><span style=display:flex><span>==&gt; Process LoadConfig: done
</span></span><span style=display:flex><span>==&gt; Process main: setup hugo file systems based on machine file system and configurations
</span></span><span style=display:flex><span>==&gt; Process newFs: create /public folder
</span></span><span style=display:flex><span>==&gt; Process newFs: new base path fs &amp;BasePathFs{}
</span></span><span style=display:flex><span>==&gt; Process main: create hugo sites based on deps
</span></span><span style=display:flex><span>==&gt; Process createSitesFromConfig: start
</span></span><span style=display:flex><span>==&gt; Process NewLanguages: create multiple languages, only &#39;en&#39; in our case
</span></span><span style=display:flex><span>==&gt; Process newSite: create site with DepsCfg with language setup
</span></span><span style=display:flex><span>==&gt; Process media.DecodeTypes: set default media types
</span></span><span style=display:flex><span>==&gt; Process output.DecodeFormats: set default output formats based on media types, and customized output formats configuration
</span></span><span style=display:flex><span>==&gt; Process site output formats: map siteOutputFormats to every hugo page types(KindPage, KindHome...)
</span></span><span style=display:flex><span>==&gt; Process createSitesFromConfig: end
</span></span><span style=display:flex><span>==&gt; Process newHugoSites: get number of worker
</span></span><span style=display:flex><span>==&gt; Process newHugoSites: init HugoSites
</span></span><span style=display:flex><span>==&gt; Process newHugoSites: add data to h.init
</span></span><span style=display:flex><span>==&gt; Process newHugoSites: add layouts to h.init
</span></span><span style=display:flex><span>==&gt; Process newHugoSites: configLoader applyDeps
</span></span><span style=display:flex><span>==&gt; Process applyDeps: set cfg.TemplateProvider with DefaultTemplateProvider
</span></span><span style=display:flex><span>==&gt; Process applyDeps: new deps
</span></span><span style=display:flex><span>==&gt; Process New PathSpec: new PathSpec with all source filesystem built
</span></span><span style=display:flex><span>==&gt; Process New resources Spec: with pathSpec, outputFormats, MediaTypes
</span></span><span style=display:flex><span>==&gt; Process New content Spec: content converter provider inside
</span></span><span style=display:flex><span>==&gt; Process New source Spec: with source filesystem and language
</span></span><span style=display:flex><span>==&gt; Process applyDeps-onCreate: set site publisher as DestinationPublisher
</span></span><span style=display:flex><span>==&gt; Process applyDeps-onCreate site initializeSiteInfo: set site title and owner
</span></span><span style=display:flex><span>==&gt; Process applyDeps-onCreate pageMap: with pageTree, bundleTree and pages, sections, resources
</span></span><span style=display:flex><span>==&gt; Process applyDeps-onCreate site PageCollections: with pageMap
</span></span><span style=display:flex><span>==&gt; Process applyDeps-onCreate site RefLinker: to manage ref link
</span></span><span style=display:flex><span>==&gt; Process applyDeps: deps LoadResources to update template provider, need to make template ready
</span></span><span style=display:flex><span>==&gt; Process templateProvider Update: new TemplateExec
</span></span><span style=display:flex><span>==&gt; Process GoFuncs: map template.GoFuncs to funcMap
</span></span><span style=display:flex><span>==&gt; Process GoFuncs: map texttemplate.GoFuncs to funcMap
</span></span><span style=display:flex><span>==&gt; Process newTemplateNamespace: with funcMap
</span></span><span style=display:flex><span>==&gt; Process NewLayoutHandler: to process layout request
</span></span><span style=display:flex><span>==&gt; Process main: hugo building...
</span></span><span style=display:flex><span>==&gt; Process HugoSites Build: start
</span></span><span style=display:flex><span>==&gt; Process HugoSites Build process: site initialize with title and owner
</span></span><span style=display:flex><span>==&gt; Process readAndProcessContent: new source spec with PathSpec, ContentInclusionFilter and BaseFs Content.Fs
</span></span><span style=display:flex><span>==&gt; Process readAndProcessContent: collect content with PagesProcessor
</span></span><span style=display:flex><span>==&gt; Process AssemblePages: pageMaps to assemble all pages
</span></span><span style=display:flex><span>==&gt; Process pm.CreateMissingNodes: check root section
</span></span><span style=display:flex><span>==&gt; Process assemblePages: assembleSections firstly
</span></span><span style=display:flex><span>==&gt; Process assemblePages: walk pageMap pages
</span></span><span style=display:flex><span>==&gt; Process pageMap pages.Walk: new page from content node
</span></span><span style=display:flex><span>==&gt; Process pageMap pages.Walk: assemble resources
</span></span><span style=display:flex><span>==&gt; Process render: h.init layouts do start
</span></span><span style=display:flex><span>==&gt; Process newHugoSites: h.init run s.Tmpl().MarkReady
</span></span><span style=display:flex><span>==&gt; Process render: init site render formats
</span></span><span style=display:flex><span>==&gt; Process site preapre pages for render: pageState init output format
</span></span><span style=display:flex><span>==&gt; Process pageState: init page do start
</span></span><span style=display:flex><span>==&gt; Process pageState: init contentProvider with page content output
</span></span><span style=display:flex><span>==&gt; Process site preapre pages for render: pageState init output format
</span></span><span style=display:flex><span>==&gt; Process pageState: init page do start
</span></span><span style=display:flex><span>==&gt; Process pageState init: new page paths
</span></span><span style=display:flex><span>==&gt; Process pageState init: new page output
</span></span><span style=display:flex><span>==&gt; Process pageState init: init OutputFormatsProvider, targetPathDescriptor, SitesProvider
</span></span><span style=display:flex><span>==&gt; Process pageState: new page content output
</span></span><span style=display:flex><span>==&gt; Process pageState: init contentProvider with page content output
</span></span><span style=display:flex><span>==&gt; Process site preapre pages for render: pageState init output format
</span></span><span style=display:flex><span>==&gt; Process pageState: init page do start
</span></span><span style=display:flex><span>==&gt; Process pageState init: new page paths
</span></span><span style=display:flex><span>==&gt; Process pageState init: new page output
</span></span><span style=display:flex><span>==&gt; Process pageState init: init OutputFormatsProvider, targetPathDescriptor, SitesProvider
</span></span><span style=display:flex><span>==&gt; Process pageState: new page content output
</span></span><span style=display:flex><span>==&gt; Process pageState: init contentProvider with page content output
</span></span><span style=display:flex><span>==&gt; Process render: render start with siteRenderContext
</span></span><span style=display:flex><span>==&gt; Process Site render: render pages
</span></span><span style=display:flex><span>==&gt; Process renderPages: start 3 workers to do page rendering
</span></span><span style=display:flex><span>==&gt; Process render page: resolve template for page
</span></span><span style=display:flex><span>==&gt; Process render page: resolve template for page
</span></span><span style=display:flex><span>==&gt; Process render page: resolve template for page
</span></span><span style=display:flex><span>==&gt; Process render and write page: render for template
</span></span><span style=display:flex><span>==&gt; Process output initContent: init render hooks
</span></span><span style=display:flex><span>==&gt; Process output initContent: content to render
</span></span><span style=display:flex><span>==&gt; Process render and write page: publish page
</span></span><span style=display:flex><span>==&gt; Process render and write page: publish page
</span></span><span style=display:flex><span>==&gt; Process Site render: render 404
</span></span><span style=display:flex><span>==&gt; Process pageState init: new page paths
</span></span><span style=display:flex><span>==&gt; Process pageState init: new page output
</span></span><span style=display:flex><span>==&gt; Process pageState init: init OutputFormatsProvider, targetPathDescriptor, SitesProvider
</span></span><span style=display:flex><span>==&gt; Process hugoSite render: cross sites robots TXT
</span></span><span style=display:flex><span>==&gt; Process pageState init: new page paths
</span></span><span style=display:flex><span>==&gt; Process pageState init: new page output
</span></span><span style=display:flex><span>==&gt; Process pageState init: init OutputFormatsProvider, targetPathDescriptor, SitesProvider
</span></span><span style=display:flex><span>==&gt; Process render and write page: render for template
</span></span><span style=display:flex><span>==&gt; Process render and write page: publish page
</span></span><span style=display:flex><span>==&gt; Process HugoSites Build: done
</span></span></code></pre></div><p>直观感受好像没有Golang Template流程看起来那么清晰。</p><p>我们现在利用DDD领域驱动开发的事件风暴方法来对日志进行分析，以帮助我们进一步理解Hugo对站点构建这一领域的理解。</p><h3 id=ddd之事件风暴>DDD之事件风暴
<a class=anchor href=#ddd%e4%b9%8b%e4%ba%8b%e4%bb%b6%e9%a3%8e%e6%9a%b4>#</a></h3><p><img src=images/2.2-ddd-event-storming.svg alt="ddd event storming"></p><p>为了帮助我们充分理解某一特定领域，统一团队所有成员对这一领域知识的认知。
DDD提出了事件风暴这一方法。
该方法以研讨会的形式，让领域专家和团队成员坐在一起，用对话的形式将领域中关键事件一一识别出来，并用卡片将达成一致的事件记录下来，贴在墙壁或白板上。</p><p>我们的领域专家就是Hugo的源码库，这里就是简化后的
<a href=https://github.com/sunwei/hugo-playground>Hugo游乐场</a>。
而上面产出的全流程日志，就是站点领域专家对关键事件的描述。</p><h3 id=hugo构建之主流程---事件风暴版>Hugo构建之主流程 - 事件风暴版
<a class=anchor href=#hugo%e6%9e%84%e5%bb%ba%e4%b9%8b%e4%b8%bb%e6%b5%81%e7%a8%8b---%e4%ba%8b%e4%bb%b6%e9%a3%8e%e6%9a%b4%e7%89%88>#</a></h3><p><img src=images/2.3-hugo-whole-process-main.svg alt="ddd event storming main process"></p><p>和之前的时序图版本对比：</p><img src=./images/0-main-process.svg alt="main process" height=200><p>同样轻量，便于理解。</p><h3 id=hugo构建之loadconfig>Hugo构建之LoadConfig
<a class=anchor href=#hugo%e6%9e%84%e5%bb%ba%e4%b9%8bloadconfig>#</a></h3><p>通过对日志3到13行的分析，加载配置项的关键事键按发生时间排列如图如示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>==&gt; Process main: load configurations from config.toml and themes
</span></span><span style=display:flex><span>==&gt; Process LoadConfig: start init configLoader
</span></span><span style=display:flex><span>==&gt; Process loadConfig: load config.toml from hard disk
</span></span><span style=display:flex><span>==&gt; Process loadConfig: set loaded config map to configLoader.cfg with key &#39;&#39;
</span></span><span style=display:flex><span>==&gt; Process LoadConfig: apply config defaults
</span></span><span style=display:flex><span>==&gt; Process LoadConfig: load modules config
</span></span><span style=display:flex><span>==&gt; Process decodeConfig: set mytheme as Imports in DefaultModuleConfig, Config{}
</span></span><span style=display:flex><span>==&gt; Process LoadConfig: collect modules with modulesConfig
</span></span><span style=display:flex><span>==&gt; Process collectHook: apply default mounts to project module
</span></span><span style=display:flex><span>==&gt; Process collectModules: set active modules to config with key &#39;allModules&#39;
</span></span><span style=display:flex><span>==&gt; Process LoadConfig: done
</span></span></code></pre></div><p><img src=images/2.4-hugo-whole-process-LoadConfig.svg alt="ddd event storming LoadConfig process"></p><ul><li>引入配置加载器，用来处理配置项的相关操作。</li><li>从硬盘读取配置文件。因为Hugo支持多种格式的配置项，如yaml, toml, json等，所以要适配这些不同类型的配置文件。</li><li>解析配置文件，根据文件后缀选用相应的解析工具，读取配置文件中的配置信息。</li><li>将解析过后的map值，保存到配置加载器的根结点，对应的键值是空字符串<code>''</code>。并会对所有的配置键值进行小写处理，并保存，所以配置项对大小写不敏感。</li><li>应用默认配置。在用户的配置文件上中没有进行说明的，将会采用Hugo默认配置项。</li><li>加载模块配置项。这里引入了模块的概念，但和Nginx的模块有所区别。Hugo的模块指的是包含Hugo文件标准结构的目录，如主题，用户项目本身。
其中主题是可以嵌套主题的，也就是说我们所使用的Theme A可能是基于Theme B构建的，而项目本身也有自己的标准目录，也可以有自己的layouts文件夹。
那覆盖顺序就是Project Layouts > Theme A Layouts > Theme B Layouts。Hugo模块只有两类，Project模块和其它模块。
从文件结构上讲，其实是一样的。</li><li>解析模块配置项。在项目配置文件config.toml中通常会配置主题项：theme = &ldquo;mytheme&rdquo;，这就是告诉配置加载器，本项目依赖于这个主题，即这个模块。</li><li>设置解析结果到模块配置项。既然模块之间可以相互依赖，那加载资源的时候就有加载顺序，需要将依赖关系提前梳理好。
Hugo实现这一需求依赖的是模块配置项的Imports字段。</li><li>根据模块配置，收集模块。通过上一步的关系梳理，现在就是加载模块的时候了，将模块文件结构，按标准文件结构解析成一个个的挂载项，为构建文件系统做准备。</li><li>应用默认挂载到项目模块。项目本身也是遵循的标准文件结构的，也需要将文件结构消化成相应的挂载项。</li><li>将活跃模块添加到配置项。在我们的用例中，有Project和Mytheme两个模块。在配置项中，对应的字段是"allModule&rdquo;。</li></ul><p>配置项包含了所有配置相关的信息，除了用户自定义的字段，还有Hugo的默认配置。
其中较为特殊的就是"allModule"字段，里面包含了包括项目模块在内的所有模块信息。
LoadConfig不仅包含常规配置项信息，不包含了模块的配置信息。</p><h3 id=hugo构建之hugofs>Hugo构建之HugoFs
<a class=anchor href=#hugo%e6%9e%84%e5%bb%ba%e4%b9%8bhugofs>#</a></h3><p>通过对日志14到24行的分析，可以看到Hugo对自身File System的理解和设计：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>==&gt; Process main: setup hugo file systems based on machine file system and configurations
</span></span><span style=display:flex><span>==&gt; Process newFs: create /public folder
</span></span><span style=display:flex><span>==&gt; Process newFs: new base path fs &amp;BasePathFs{}
</span></span><span style=display:flex><span>==&gt; Process main: create hugo sites based on deps
</span></span><span style=display:flex><span>==&gt; Process createSitesFromConfig: start
</span></span><span style=display:flex><span>==&gt; Process NewLanguages: create multiple languages, only &#39;en&#39; in our case
</span></span><span style=display:flex><span>==&gt; Process newSite: create site with DepsCfg with language setup
</span></span><span style=display:flex><span>==&gt; Process media.DecodeTypes: set default media types
</span></span><span style=display:flex><span>==&gt; Process output.DecodeFormats: set default output formats based on media types, and customized output formats configuration
</span></span><span style=display:flex><span>==&gt; Process site output formats: map siteOutputFormats to every hugo page types(KindPage, KindHome...)
</span></span><span style=display:flex><span>==&gt; Process createSitesFromConfig: end
</span></span></code></pre></div><p><img src=images/2.5-hugo-whole-process-hugofs.svg alt="ddd event storming Hugo Fs"></p><ul><li>创建public文件夹。public是默认的站点发布文件夹名，当然，也支持自定义。</li><li>创建基本路径Fs。只包含源项目文件系统和发布文件系统，也是Hugo文件系统基础所在。</li><li>创建多语言。Hugo支持多语言站点发布。会是语言为单位，在包含基础配置信息的基础上，准备相应的语言配置信息，也可以将语言描述对象理解为语言配置项。</li><li>设置站点依赖。如果要构建站点，会依赖很多信息。Hugo将所有的信息都放在了依赖里。如上面提到的基础路径文件系统及配置项。当然远不止这两项。</li><li>设置站点语言。Hugo公为每个语言生成一个站点。</li><li>设置站点默认媒体类型。站点资源要符合Web服务器要求，就需要保证站点的媒体内容是Hugo所支持的，并可正确转换成Web服务器支持的媒体类型。</li><li>设置站点默认输出格式。用户产出的内容将会以Web服务器支持的格式进行输出，所以输出格式也是站点的一部分。</li><li>映射站点输出格式到所有页面类型。Hugo将页面分为了五类，每一类和输出格式是如何对应的，也需要在这里进行说明。</li></ul><p>从HugoFs可以理解到。
Hugo认为一个站点，需要包含：</p><ul><li>源，也就是用户创造的内容。</li><li>发布地址，public文件系统</li><li>配置信息，包含用户自定义、默认配置，及所有模块的相关信息。</li><li>语言，和站点一一对应，多个语言对应多个站点</li><li>输出格式，以什么形式进行渲染。输出格式中包含了媒体类型，如HTML格式通常是text/html类型。</li></ul><h3 id=hugo构建之sites>Hugo构建之Sites
<a class=anchor href=#hugo%e6%9e%84%e5%bb%ba%e4%b9%8bsites>#</a></h3><p>通过对日志25到46行的分析，可以看到Hugo对Sites的理解和设计：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>==&gt; Process newHugoSites: get number of worker
</span></span><span style=display:flex><span>==&gt; Process newHugoSites: init HugoSites
</span></span><span style=display:flex><span>==&gt; Process newHugoSites: add data to h.init
</span></span><span style=display:flex><span>==&gt; Process newHugoSites: add layouts to h.init
</span></span><span style=display:flex><span>==&gt; Process newHugoSites: configLoader applyDeps
</span></span><span style=display:flex><span>==&gt; Process applyDeps: set cfg.TemplateProvider with DefaultTemplateProvider
</span></span><span style=display:flex><span>==&gt; Process applyDeps: new deps
</span></span><span style=display:flex><span>==&gt; Process New PathSpec: new PathSpec with all source filesystem built
</span></span><span style=display:flex><span>==&gt; Process New resources Spec: with pathSpec, outputFormats, MediaTypes
</span></span><span style=display:flex><span>==&gt; Process New content Spec: content converter provider inside
</span></span><span style=display:flex><span>==&gt; Process New source Spec: with source filesystem and language
</span></span><span style=display:flex><span>==&gt; Process applyDeps-onCreate: set site publisher as DestinationPublisher
</span></span><span style=display:flex><span>==&gt; Process applyDeps-onCreate site initializeSiteInfo: set site title and owner
</span></span><span style=display:flex><span>==&gt; Process applyDeps-onCreate pageMap: with pageTree, bundleTree and pages, sections, resources
</span></span><span style=display:flex><span>==&gt; Process applyDeps-onCreate site PageCollections: with pageMap
</span></span><span style=display:flex><span>==&gt; Process applyDeps-onCreate site RefLinker: to manage ref link
</span></span><span style=display:flex><span>==&gt; Process applyDeps: deps LoadResources to update template provider, need to make template ready
</span></span><span style=display:flex><span>==&gt; Process templateProvider Update: new TemplateExec
</span></span><span style=display:flex><span>==&gt; Process GoFuncs: map template.GoFuncs to funcMap
</span></span><span style=display:flex><span>==&gt; Process GoFuncs: map texttemplate.GoFuncs to funcMap
</span></span><span style=display:flex><span>==&gt; Process newTemplateNamespace: with funcMap
</span></span><span style=display:flex><span>==&gt; Process NewLayoutHandler: to process layout request
</span></span></code></pre></div><p><img src=images/2.6-hugo-whole-process-hugo-sites.svg alt="ddd event storming sites process"></p><ul><li>获取worker容量。将会决定在渲染过程中有几个goroutine用来渲染页面。</li><li>初始化Hugo Sites。在Hugo里有两个site，一个是Sites，另一个是HugoSites。Site和Language一一对应，HugoSites和Site是一对多的关系。</li><li>注册data相关处理行为到初始化。Hugo用到了lazy init的，因为有一些初始化的工作依赖于某些处理后的数据，需要在一开始说明，但在适当的时机激活。</li><li>注册layouts相关处理行为到初始化。同上，Hugo layouts就相当于是golang里的模板，这里会真正加载内部模板和用户自定义模板。</li><li>配置加载器应用依赖。将依赖关联到配置加载器中。</li><li>设置默认模板提供方到配置。负责提供模板相关的服务，并且关联到配置中。</li><li>新建依赖。创建依赖实例，关联之前准备的依赖项。</li><li>新建路径规范。PathSpec，根据所有模块的挂载信息，和Hugo标准文件结构，生成OverlayFs格式的统一文件系统服务。</li><li>新建资源规范。ResourceSpec，基于PathSpec，提供不同资源的处理工具，如图片。</li><li>新建内容规范。ContentSpec，基于PathSpec中的Content.Fs，提供站点内容相关的具体服务，如内容长度统计等。</li><li>新建来源规范。SourceSpec，对BaseFs中的source统一管理，提供过滤等服务。</li><li>设置站点发布者。当站点准备好发布时，发布相关的工作都由发布者负责。</li><li>设置站点标题。对站点基础信息标题进行设置，包括标题的处理函数。如全大写、驼峰、首标题第一个字首字母大写等。</li><li>设置站点所有者。既站点的拥有者。</li><li>初始化页面映射。PageMap，一个站点会有一个PageMap，用来管理所有的Page，在Hugo里Page指所有站点不同类型的页面，像Home, Section, Term等。</li><li>设置站点页面收集器。如何将实际用户创作的内容，如post、页面管理生成的内容，如section和目录结构一一映射，并用PageMap管理起来，谁来负责 - 页面收集器。</li><li>设置站点索引链接器。页面是一个个的页面，页面之间的关系需要索引来进行管理。</li><li>通过模板提供者开始更新。通过上面的配置信息，对模板配置进行更新。</li><li>新建模板执行器。当模板全部加载和转换完成后，新建TemplateExec对外提供执行功能，将内容按模板进行渲染。</li><li>收集模板函数到函数映射。Golang Template提供了一些内置函数，方便用程序的形式处理一些内容，如print。Hugo对此进行了增强，定义了很多功能强大的函数。</li><li>收集文本函数到函数映射。Hugo提供了两大类函数，一大类来自于默认template，另一大类来自于text template。</li><li>新建模板命名空间。前模板相关信息封闭在命名空间中，这样方便治理各类模板和函数。</li><li>新建layout处理器。在对外提供服务时，还可以根据需求对layout进行最后的转换，以满足一些定制化需求。</li></ul><h3 id=hugo构建之loadconfig-1>Hugo构建之LoadConfig
<a class=anchor href=#hugo%e6%9e%84%e5%bb%ba%e4%b9%8bloadconfig-1>#</a></h3><p>通过对日志47到99行的分析，可以看到Hugo如何构建站点的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>==&gt; Process main: hugo building...
</span></span><span style=display:flex><span>==&gt; Process HugoSites Build: start
</span></span><span style=display:flex><span>==&gt; Process HugoSites Build process: site initialize with title and owner
</span></span><span style=display:flex><span>==&gt; Process readAndProcessContent: new source spec with PathSpec, ContentInclusionFilter and BaseFs Content.Fs
</span></span><span style=display:flex><span>==&gt; Process readAndProcessContent: collect content with PagesProcessor
</span></span><span style=display:flex><span>==&gt; Process AssemblePages: pageMaps to assemble all pages
</span></span><span style=display:flex><span>==&gt; Process pm.CreateMissingNodes: check root section
</span></span><span style=display:flex><span>==&gt; Process assemblePages: assembleSections firstly
</span></span><span style=display:flex><span>==&gt; Process assemblePages: walk pageMap pages
</span></span><span style=display:flex><span>==&gt; Process pageMap pages.Walk: new page from content node
</span></span><span style=display:flex><span>==&gt; Process pageMap pages.Walk: assemble resources
</span></span><span style=display:flex><span>==&gt; Process render: h.init layouts do start
</span></span><span style=display:flex><span>==&gt; Process newHugoSites: h.init run s.Tmpl().MarkReady
</span></span><span style=display:flex><span>==&gt; Process render: init site render formats
</span></span><span style=display:flex><span>==&gt; Process site preapre pages for render: pageState init output format
</span></span><span style=display:flex><span>==&gt; Process pageState: init page do start
</span></span><span style=display:flex><span>==&gt; Process pageState: init contentProvider with page content output
</span></span><span style=display:flex><span>==&gt; Process site preapre pages for render: pageState init output format
</span></span><span style=display:flex><span>==&gt; Process pageState: init page do start
</span></span><span style=display:flex><span>==&gt; Process pageState init: new page paths
</span></span><span style=display:flex><span>==&gt; Process pageState init: new page output
</span></span><span style=display:flex><span>==&gt; Process pageState init: init OutputFormatsProvider, targetPathDescriptor, SitesProvider
</span></span><span style=display:flex><span>==&gt; Process pageState: new page content output
</span></span><span style=display:flex><span>==&gt; Process pageState: init contentProvider with page content output
</span></span><span style=display:flex><span>==&gt; Process site preapre pages for render: pageState init output format
</span></span><span style=display:flex><span>==&gt; Process pageState: init page do start
</span></span><span style=display:flex><span>==&gt; Process pageState init: new page paths
</span></span><span style=display:flex><span>==&gt; Process pageState init: new page output
</span></span><span style=display:flex><span>==&gt; Process pageState init: init OutputFormatsProvider, targetPathDescriptor, SitesProvider
</span></span><span style=display:flex><span>==&gt; Process pageState: new page content output
</span></span><span style=display:flex><span>==&gt; Process pageState: init contentProvider with page content output
</span></span><span style=display:flex><span>==&gt; Process render: render start with siteRenderContext
</span></span><span style=display:flex><span>==&gt; Process Site render: render pages
</span></span><span style=display:flex><span>==&gt; Process renderPages: start 3 workers to do page rendering
</span></span><span style=display:flex><span>==&gt; Process render page: resolve template for page
</span></span><span style=display:flex><span>==&gt; Process render page: resolve template for page
</span></span><span style=display:flex><span>==&gt; Process render page: resolve template for page
</span></span><span style=display:flex><span>==&gt; Process render and write page: render for template
</span></span><span style=display:flex><span>==&gt; Process output initContent: init render hooks
</span></span><span style=display:flex><span>==&gt; Process output initContent: content to render
</span></span><span style=display:flex><span>==&gt; Process render and write page: publish page
</span></span><span style=display:flex><span>==&gt; Process render and write page: publish page
</span></span><span style=display:flex><span>==&gt; Process Site render: render 404
</span></span><span style=display:flex><span>==&gt; Process pageState init: new page paths
</span></span><span style=display:flex><span>==&gt; Process pageState init: new page output
</span></span><span style=display:flex><span>==&gt; Process pageState init: init OutputFormatsProvider, targetPathDescriptor, SitesProvider
</span></span><span style=display:flex><span>==&gt; Process hugoSite render: cross sites robots TXT
</span></span><span style=display:flex><span>==&gt; Process pageState init: new page paths
</span></span><span style=display:flex><span>==&gt; Process pageState init: new page output
</span></span><span style=display:flex><span>==&gt; Process pageState init: init OutputFormatsProvider, targetPathDescriptor, SitesProvider
</span></span><span style=display:flex><span>==&gt; Process render and write page: render for template
</span></span><span style=display:flex><span>==&gt; Process render and write page: publish page
</span></span><span style=display:flex><span>==&gt; Process HugoSites Build: done
</span></span></code></pre></div><p><img src=images/2.7-hugo-whole-process-hugo-build.svg alt="ddd event storming build process"></p><ul><li>检查站点标题。开始构建之前，先检查一下是否设置好了这些基础信息。</li><li>检查站点所有者信息。同上。</li><li>为内容Fs新建来源规范。SourceSpec，针对正在构建的站点，进一步定制化，说明哪些文件需要处理，哪些应该忽略。</li><li>用页面收集器收集站点内容。上一阶段是准备阶段，构建阶段是真正地收集阶段。</li><li>用页面映射聚集所有页面。一个站点对应一个PageMap，根据上面收集的结果，对收集到的页面进行一一映射管理。</li><li>走查缺失结点。Hugo引入了section概念，这样方便管理内容的层级关系。
在收集页面时，Hugo用的是
<a href=https://en.wikipedia.org/wiki/Radix_tree>基数树</a>对页面进行管理的。
这样对于section而言，就需要在树结构中补全相应缺失结点。</li><li>聚集章节。章节也是一种页面类型，上面是针对页面走查缺失的章节结点，对页面信息进行补全。这里是专门用来处理章节。</li><li>为内容结点创建页面。我们最终的目标是把收集到的信息，用模板给渲染出来，这里创建的页面PageState结构体，就是上面代码例子中的Post，用来为渲染做准备。</li><li>聚集页面资源。一篇博客中会引用一起图片，数据等，都属于博客的资源，需要和页面对应上。</li><li>回调layout注册项进行初始化。在一开始注册的模板提供方和注册到lazy init里的加调方法，对模板内容文件进行处理。如模板解析，加入命名空间等。</li><li>初始化渲染格式。通过前面的输出信息，明确渲染要求，并进行输出。</li><li>初始化页面状态。PageState，前面是准备初始化所需的内容，这里专门进行初始化。
作为渲染的关键，因为所有模板需要的信息都依赖于这个结构体，这导致PageState结构体体积巨大。</li><li>初始化内容提供商。对于渲染阶段而言，重点是将内容转换为站点文件，抽象出对应的服务，有助于封装隐藏在背后的复杂度，方便消费者使用。</li><li>标明页面内容输出格式。Hugo支持对同一页面输出多种格式，这里就是为满足用户的输出需求进行准备。</li><li>新建页面路径。PagePath，为PageState准备页面路径相关的信息，帮助说明输出格式，及目标发布地址。</li><li>新建页面输出。PageOutput，包含所有输出所需要的信息，如页面渲染提供商、Table of Content提供商等。</li><li>初始化页面输出供应商。获取相应的配置信息并初始化。</li><li>初始化页面目标路径描述符。页面将要发布到哪个目标，需要用描述符承载相应的信息。</li><li>初始化页面站点供应商。和站点相关的信息在此维护。</li><li>新建页面内容输出。和页面内容输出相关的信息在此提供。</li><li>用页面输出初始化内容供应商。内容供应商依赖于页面内容输出。</li><li>Worker开始渲染页面。当渲染流程中的对象都准备就绪时，由上一步提供的worker开始获取渲染业务，并进行实际渲染。</li><li>为页面查找模板。通过模板提供商查找页面模板，为了组织起所有内容，Hugo提供了模板查找逻辑，帮助定位合适的模板。</li><li>用模板渲染页面。通过模板执行器，对PageState进行渲染。</li><li>初始化渲染回调钩子。提供渲染过程中的交互接口。</li><li>初始化渲染内容。为页面输出配置相关博客内容。</li><li>发布页面。将渲染好的内容发布到对应目标地址。</li><li>渲染404。对应用户博客，404页面属于独立页面，可以重用上面的流程进行渲染和发布。</li><li>渲染robots TXT说明文件。对于搜索引擎提供爬取说明。和404页面一样属于独立页面。</li></ul><h2 id=小结>小结
<a class=anchor href=#%e5%b0%8f%e7%bb%93>#</a></h2><p><img src=images/2-hugo-whole-process.svg alt="hugo whole process events"></p><p>本章用DDD事件驱动开发中的事件风暴Event Storming方法，对Hugo构建全流程中的关键事件进行了收集和分析，以帮助大家了解到构建的全过程。</p><p>可以看到，基于Golang Template提供的基础功能，Hugo在此基础上，进行了增强：</p><p><img src=images/2.1-hugo-whole-process-map-go-template.svg alt="hugo whole process with golang template"></p><p>Hugo眼中的站点构建，需要涵盖从用户博客项目到发布站点的全流程。</p><p>首先要通过配置文件理解用户对站点的具体需求，如想用哪个风格的主题，站点叫什么名字，要支持几种语言，以及以什么格式进行输出。
为了减轻用户的认知负担，Hugo采用主动配置加默认配置的策略，帮助用户补全构建站点所需要的其它信息。</p><p>了解了用户需求后，Hugo需要将用户的博客内容有效地进行组织。
项目内包含了主题，甚至主题里面还嵌套了主题。
还包含了项目本身的所有文件。
无论是主题，还是博客本身，都遵循下面这一目录结构:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── archetypes
</span></span><span style=display:flex><span>├── config.toml
</span></span><span style=display:flex><span>├── content
</span></span><span style=display:flex><span>├── data
</span></span><span style=display:flex><span>├── layouts
</span></span><span style=display:flex><span>├── public
</span></span><span style=display:flex><span>├── static
</span></span><span style=display:flex><span>└── themes
</span></span></code></pre></div><p>在组织这些文件时，就需要考虑这些文件的依赖关系，像layouts之间是覆盖的关系，这就对挂载顺序有要求。
而像static目录相对比较特殊，所有的文件是什么样，就原封不动的拷贝到最终目录。
面对这些需求，Hugo的做法是将博客本身视为一个模块，同样将主题模块也视为一个模块，并清晰的用挂载点来帮助说明具体的信息，并将解析后的信息放入配置结构中。
后续通过这些信息，用OverlayFs技术提供需要合并的服务，用BaseFs提供基础的文件服务，还有大而全的标准服务。</p><p>配置信息全了，文件系统也按需求准备好了，接下来就要开始收集站点的页面了。
Hugo为content目录定义了Section章节概念：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>content
</span></span><span style=display:flex><span>└── blog        &lt;-- Section, because first-level dir under content/
</span></span><span style=display:flex><span>    ├── funny-cats
</span></span><span style=display:flex><span>    │   ├── mypost.md
</span></span><span style=display:flex><span>    │   └── kittens         &lt;-- Section, because contains _index.md
</span></span><span style=display:flex><span>    │       └── _index.md
</span></span><span style=display:flex><span>    └── tech                &lt;-- Section, because contains _index.md
</span></span><span style=display:flex><span>        └── _index.md
</span></span></code></pre></div><p>这样，在扫描所有文章的同时，还需要关注章节的相关信息。
所以在扫描完所有的文章后，还需要补全章节的结点，并进行专门的章节扫描。</p><p>最后根据输出的要求，用layouts模板对收集到的页面信息PageState进行渲染，输出并发布到指定目录。</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/sunwei/hugo-notes/commit/1ef7760866ad1f04b1423099007532b22f57a593 title='Last modified by sunwei | February 7, 2023' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>February 7, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/sunwei/hugo-notes/edit/main/content/docs/how/event-storming/index.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#hugo-事件风暴>Hugo 事件风暴</a><ul><li><a href=#golang-template>GoLang Template</a><ul><li><a href=#show-me-the-code>Show Me The Code</a></li></ul></li><li><a href=#看hugo对站点构建的理解和设计>看Hugo对站点构建的理解和设计</a><ul><li><a href=#ddd之事件风暴>DDD之事件风暴</a></li><li><a href=#hugo构建之主流程---事件风暴版>Hugo构建之主流程 - 事件风暴版</a></li><li><a href=#hugo构建之loadconfig>Hugo构建之LoadConfig</a></li><li><a href=#hugo构建之hugofs>Hugo构建之HugoFs</a></li><li><a href=#hugo构建之sites>Hugo构建之Sites</a></li><li><a href=#hugo构建之loadconfig-1>Hugo构建之LoadConfig</a></li></ul></li><li><a href=#小结>小结</a></li></ul></li></ul></nav></div></aside></main></body></html>